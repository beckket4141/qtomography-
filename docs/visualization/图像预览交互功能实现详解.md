# å›¾åƒé¢„è§ˆäº¤äº’åŠŸèƒ½å®ç°è¯¦è§£

> **æœ€åæ›´æ–°**: 2025å¹´11æœˆ  
> **çŠ¶æ€**: âš ï¸ éƒ¨åˆ†è·¯å¾„å·²æ›´æ–°ï¼Œè¯·å‚è€ƒå®é™…å®ç°

## ğŸ“‹ æ¦‚è¿°

æœ¬æ–‡æ¡£è¯¦ç»†è§£æå›¾åƒé¢„è§ˆç»„ä»¶ä¸­**æ”¾å¤§ã€ç¼©å°ã€å¤ä½ã€å…¨å±**ç­‰äº¤äº’åŠŸèƒ½çš„å®ç°ç»†èŠ‚ï¼ŒåŒ…æ‹¬æŠ€æœ¯åŸç†ã€ä»£ç å®ç°å’Œå…³é”®æŠ€å·§ã€‚

> **æ³¨æ„**: æœ¬æ–‡æ¡£æè¿°çš„æ˜¯é€šç”¨çš„å›¾åƒé¢„è§ˆå®ç°åŸç†ã€‚å®é™…å®ç°ä½ç½®ä¸º `qtomography/gui/widgets/image_viewer.py`ã€‚

---

## ğŸ—ï¸ æŠ€æœ¯æ¶æ„

### æ ¸å¿ƒç»„ä»¶

**å®é™…å®ç°**: `ImageViewer` (ä½äº `qtomography/gui/widgets/image_viewer.py`)

```
ImageViewer (QGraphicsView)
â”œâ”€â”€ QGraphicsView (è§†å›¾)
â”‚   â”œâ”€â”€ ç¼©æ”¾å˜æ¢ (scale)
â”‚   â”œâ”€â”€ å¹³ç§»å˜æ¢ (æ‹–æ‹½)
â”‚   â””â”€â”€ è§†å›¾é”šç‚¹ (AnchorUnderMouse)
â”œâ”€â”€ QGraphicsScene (åœºæ™¯)
â”‚   â””â”€â”€ QGraphicsPixmapItem (å›¾åƒé¡¹)
â””â”€â”€ äº¤äº’æ§åˆ¶
    â”œâ”€â”€ é¼ æ ‡æ»šè½®ç¼©æ”¾
    â”œâ”€â”€ æŒ‰é’®ç¼©æ”¾
    â”œâ”€â”€ æ‹–æ‹½å¹³ç§»
    â””â”€â”€ å…¨å±æ˜¾ç¤ºï¼ˆåœ¨FigurePanelä¸­å®ç°ï¼‰
```

---

## ğŸ” åŠŸèƒ½1ï¼šæ”¾å¤§åŠŸèƒ½

### å®ç°åŸç†

**æ ¸å¿ƒæ–¹æ³•**: `QGraphicsView.scale(sx, sy)`

ç¼©æ”¾é€šè¿‡**å˜æ¢çŸ©é˜µ**å®ç°ï¼ŒQtå†…éƒ¨ç»´æŠ¤ä¸€ä¸ªå˜æ¢çŸ©é˜µï¼Œæ¯æ¬¡è°ƒç”¨`scale()`ä¼šç´¯ç§¯å˜æ¢ã€‚

### ä»£ç å®ç°

**ä½ç½®**: `qtomography/gui/widgets/image_viewer.py` (48-52è¡Œ)

> **æ³¨æ„**: åŸæ–‡æ¡£ä¸­çš„è·¯å¾„ `ui/components/image_preview_widget.py` å·²æ›´æ–°ä¸ºå®é™…å®ç°è·¯å¾„ã€‚

```python
def zoom_in(self):
    """æ”¾å¤§"""
    if self.current_pixmap is None:
        return
    
    # 1. å®šä¹‰ç¼©æ”¾å› å­ï¼ˆ1.2å€ï¼‰
    scale_factor = 1.2
    
    # 2. è®¡ç®—æ–°çš„ç¼©æ”¾æ¯”ä¾‹
    new_zoom = min(self.max_zoom, self.zoom_factor * scale_factor)
    
    # 3. æ£€æŸ¥æ˜¯å¦è¾¾åˆ°ä¸Šé™
    if new_zoom != self.zoom_factor:
        # 4. æ›´æ–°ç¼©æ”¾å› å­
        self.zoom_factor = new_zoom
        
        # 5. åº”ç”¨ç¼©æ”¾å˜æ¢ï¼ˆä»¥é¼ æ ‡ä½ç½®ä¸ºä¸­å¿ƒï¼‰
        self.graphics_view.scale(scale_factor, scale_factor)
        
        # 6. æ›´æ–°çŠ¶æ€æ˜¾ç¤º
        self._update_zoom_status()
```

### å…³é”®æŠ€æœ¯ç‚¹

#### 1. ç¼©æ”¾ä¸­å¿ƒç‚¹

**å…³é”®è®¾ç½®** (53-54è¡Œ):
```python
self.graphics_view.setTransformationAnchor(
    QGraphicsView.ViewportAnchor.AnchorUnderMouse
)
self.graphics_view.setResizeAnchor(
    QGraphicsView.ViewportAnchor.AnchorUnderMouse
)
```

**ä½œç”¨**:
- `AnchorUnderMouse`: ç¼©æ”¾æ—¶ä»¥**é¼ æ ‡ä½ç½®**ä¸ºä¸­å¿ƒ
- æä¾›æ›´è‡ªç„¶çš„äº¤äº’ä½“éªŒ
- ç”¨æˆ·å¯ä»¥ç²¾ç¡®æ§åˆ¶æŸ¥çœ‹åŒºåŸŸ

**å¯¹æ¯”**:
- `AnchorViewCenter`: ä»¥è§†å›¾ä¸­å¿ƒç¼©æ”¾ï¼ˆä¸æ¨èï¼‰
- `AnchorUnderMouse`: ä»¥é¼ æ ‡ä½ç½®ç¼©æ”¾ï¼ˆæ¨èï¼‰âœ“

#### 2. ç¼©æ”¾é™åˆ¶

```python
self.min_zoom = 0.25  # æœ€å°ç¼©æ”¾ï¼š25%
self.max_zoom = 4.0   # æœ€å¤§ç¼©æ”¾ï¼š400%

new_zoom = min(self.max_zoom, self.zoom_factor * scale_factor)
```

**ä½œç”¨**:
- é˜²æ­¢è¿‡åº¦ç¼©æ”¾å¯¼è‡´æ€§èƒ½é—®é¢˜
- é˜²æ­¢ç¼©æ”¾è¿‡å°å¯¼è‡´å›¾åƒä¸å¯è§
- ä¿æŠ¤ç”¨æˆ·ä½“éªŒ

#### 3. ç¼©æ”¾å› å­é€‰æ‹©

```python
scale_factor = 1.2  # æŒ‰é’®ç¼©æ”¾ï¼š20%æ­¥é•¿
```

**ä¸ºä»€ä¹ˆé€‰æ‹©1.2ï¼Ÿ**
- âœ… æ­¥é•¿é€‚ä¸­ï¼Œä¸ä¼šå¤ªå¿«æˆ–å¤ªæ…¢
- âœ… æ•°å­¦ä¸Šï¼š1.2^5 â‰ˆ 2.5ï¼Œ5æ¬¡ç‚¹å‡»çº¦æ”¾å¤§2.5å€
- âœ… ç”¨æˆ·ä½“éªŒå¥½

---

## ğŸ” åŠŸèƒ½2ï¼šç¼©å°åŠŸèƒ½

### å®ç°åŸç†

ç¼©å°æ˜¯æ”¾å¤§çš„**é€†æ“ä½œ**ï¼Œä½¿ç”¨**å€’æ•°ç¼©æ”¾å› å­**ã€‚

### ä»£ç å®ç°

**ä½ç½®**: `ui/components/image_preview_widget.py` (164-173è¡Œ)

```python
def zoom_out(self):
    """ç¼©å°"""
    if self.current_pixmap is None:
        return
    
    # 1. å®šä¹‰ç¼©æ”¾å› å­ï¼ˆ1/1.2 = 0.833...ï¼‰
    scale_factor = 1.0 / 1.2
    
    # 2. è®¡ç®—æ–°çš„ç¼©æ”¾æ¯”ä¾‹
    new_zoom = max(self.min_zoom, self.zoom_factor * scale_factor)
    
    # 3. æ£€æŸ¥æ˜¯å¦è¾¾åˆ°ä¸‹é™
    if new_zoom != self.zoom_factor:
        # 4. æ›´æ–°ç¼©æ”¾å› å­
        self.zoom_factor = new_zoom
        
        # 5. åº”ç”¨ç¼©æ”¾å˜æ¢
        self.graphics_view.scale(scale_factor, scale_factor)
        
        # 6. æ›´æ–°çŠ¶æ€æ˜¾ç¤º
        self._update_zoom_status()
```

### å…³é”®æŠ€æœ¯ç‚¹

#### ç¼©æ”¾å› å­çš„å¯¹ç§°æ€§

```python
# æ”¾å¤§ï¼š1.2å€
scale_factor_in = 1.2

# ç¼©å°ï¼š1/1.2å€ï¼ˆçº¦0.833ï¼‰
scale_factor_out = 1.0 / 1.2
```

**éªŒè¯å¯¹ç§°æ€§**:
- æ”¾å¤§1.2å€ï¼Œå†ç¼©å°1/1.2å€ = 1.0ï¼ˆæ¢å¤åŸçŠ¶ï¼‰âœ“
- ä¿è¯ç¼©æ”¾æ“ä½œçš„**å¯é€†æ€§**

---

## ğŸ” åŠŸèƒ½3ï¼šé¼ æ ‡æ»šè½®ç¼©æ”¾

### å®ç°åŸç†

**äº‹ä»¶é‡å†™**: é‡å†™`QGraphicsView.wheelEvent()`æ–¹æ³•ï¼Œæ‹¦æˆªæ»šè½®äº‹ä»¶ã€‚

### ä»£ç å®ç°

**ä½ç½®**: `ui/components/image_preview_widget.py` (131-146è¡Œ)

```python
def _on_wheel_event(self, event: QWheelEvent):
    """é¼ æ ‡æ»šè½®ç¼©æ”¾"""
    # 1. æ£€æŸ¥æ˜¯å¦æœ‰å›¾åƒ
    if self.current_pixmap is None:
        return super().wheelEvent(event)  # ä½¿ç”¨é»˜è®¤è¡Œä¸º
    
    # 2. è·å–æ»šè½®æ»šåŠ¨é‡
    delta = event.angleDelta().y()
    # delta > 0: å‘ä¸Šæ»šåŠ¨ï¼ˆæ”¾å¤§ï¼‰
    # delta < 0: å‘ä¸‹æ»šåŠ¨ï¼ˆç¼©å°ï¼‰
    
    # 3. è®¡ç®—ç¼©æ”¾å› å­ï¼ˆ1.15å€ï¼Œæ¯”æŒ‰é’®æ›´ç²¾ç»†ï¼‰
    scale_factor = 1.15 if delta > 0 else 1.0 / 1.15
    
    # 4. è®¡ç®—æ–°çš„ç¼©æ”¾æ¯”ä¾‹
    new_zoom = self.zoom_factor * scale_factor
    
    # 5. é™åˆ¶åœ¨èŒƒå›´å†…
    new_zoom = max(self.min_zoom, min(self.max_zoom, new_zoom))
    
    # 6. åº”ç”¨ç¼©æ”¾ï¼ˆå¦‚æœæœ‰æ•ˆï¼‰
    if new_zoom != self.zoom_factor:
        self.zoom_factor = new_zoom
        # ä»¥é¼ æ ‡ä½ç½®ä¸ºä¸­å¿ƒç¼©æ”¾
        self.graphics_view.scale(scale_factor, scale_factor)
        self._update_zoom_status()
```

### å…³é”®æŠ€æœ¯ç‚¹

#### 1. äº‹ä»¶ç»‘å®š

**ä½ç½®**: `ui/components/image_preview_widget.py` (60è¡Œ)

```python
self.graphics_view.wheelEvent = self._on_wheel_event
```

**è¯´æ˜**:
- ç›´æ¥æ›¿æ¢`wheelEvent`æ–¹æ³•
- æ‹¦æˆªæ‰€æœ‰æ»šè½®äº‹ä»¶
- å®ç°è‡ªå®šä¹‰ç¼©æ”¾é€»è¾‘

#### 2. æ»šè½®æ–¹å‘åˆ¤æ–­

```python
delta = event.angleDelta().y()
# angleDelta()è¿”å›QPointï¼Œy()æ˜¯å‚ç›´æ»šåŠ¨é‡
# > 0: å‘ä¸Šæ»šåŠ¨ï¼ˆæ”¾å¤§ï¼‰
# < 0: å‘ä¸‹æ»šåŠ¨ï¼ˆç¼©å°ï¼‰
```

#### 3. ç¼©æ”¾æ­¥é•¿å·®å¼‚

```python
# æŒ‰é’®ç¼©æ”¾ï¼š1.2å€ï¼ˆ20%æ­¥é•¿ï¼‰
scale_factor_button = 1.2

# æ»šè½®ç¼©æ”¾ï¼š1.15å€ï¼ˆ15%æ­¥é•¿ï¼‰
scale_factor_wheel = 1.15
```

**ä¸ºä»€ä¹ˆä¸åŒï¼Ÿ**
- æ»šè½®æ“ä½œæ›´é¢‘ç¹ï¼Œéœ€è¦æ›´ç²¾ç»†çš„æ§åˆ¶
- æŒ‰é’®æ“ä½œæ˜¯ç¦»æ•£çš„ï¼Œå¯ä»¥æ­¥é•¿å¤§ä¸€äº›
- æä¾›ä¸¤ç§ä¸åŒçš„ç¼©æ”¾ä½“éªŒ

---

## ğŸ” åŠŸèƒ½4ï¼šå¤ä½åŠŸèƒ½

### å®ç°åŸç†

å¤ä½éœ€è¦ï¼š
1. **é‡ç½®å˜æ¢çŸ©é˜µ**ï¼š`resetTransform()`
2. **é‡ç½®ç¼©æ”¾å› å­**ï¼š`zoom_factor = 1.0`
3. **é‡æ–°è‡ªé€‚åº”æ˜¾ç¤º**ï¼š`fitInView()`

### ä»£ç å®ç°

**ä½ç½®**: `ui/components/image_preview_widget.py` (175-184è¡Œ)

```python
def reset_view(self):
    """é‡ç½®è§†å›¾"""
    # 1. é‡ç½®ç¼©æ”¾å› å­
    self.zoom_factor = 1.0
    
    # 2. é‡ç½®å˜æ¢çŸ©é˜µï¼ˆæ¸…é™¤æ‰€æœ‰ç¼©æ”¾å’Œå¹³ç§»ï¼‰
    self.graphics_view.resetTransform()
    
    # 3. é‡æ–°æ˜¾ç¤ºå›¾åƒ
    if self.current_pixmap:
        # æ¸…é™¤åœºæ™¯ä¸­çš„æ—§å›¾åƒ
        self.graphics_scene.clear()
        
        # æ·»åŠ å›¾åƒåˆ°åœºæ™¯
        pixmap_item = self.graphics_scene.addPixmap(self.current_pixmap)
        
        # è‡ªé€‚åº”æ˜¾ç¤ºï¼ˆä¿æŒå®½é«˜æ¯”ï¼Œå®Œæ•´æ˜¾ç¤ºï¼‰
        self.graphics_view.fitInView(
            pixmap_item, 
            Qt.AspectRatioMode.KeepAspectRatio
        )
        
        # æ›´æ–°çŠ¶æ€
        self._update_zoom_status()
```

### å…³é”®æŠ€æœ¯ç‚¹

#### 1. resetTransform()çš„ä½œç”¨

```python
self.graphics_view.resetTransform()
```

**ä½œç”¨**:
- æ¸…é™¤æ‰€æœ‰å˜æ¢ï¼ˆç¼©æ”¾ã€å¹³ç§»ã€æ—‹è½¬ï¼‰
- å°†å˜æ¢çŸ©é˜µé‡ç½®ä¸ºå•ä½çŸ©é˜µ
- è§†å›¾å›åˆ°åˆå§‹çŠ¶æ€

**å˜æ¢çŸ©é˜µ**:
```
åˆå§‹çŠ¶æ€: [1  0  0]
          [0  1  0]
          [0  0  1]

ç¼©æ”¾å:   [sx 0  0]
          [0  sy 0]
          [0  0  1]

resetTransform()å: æ¢å¤ä¸ºå•ä½çŸ©é˜µ
```

#### 2. fitInView()çš„ç®—æ³•

```python
self.graphics_view.fitInView(
    pixmap_item, 
    Qt.AspectRatioMode.KeepAspectRatio
)
```

**ç®—æ³•æ­¥éª¤**:
1. è·å–è§†å›¾å¯ç”¨åŒºåŸŸå¤§å°
2. è·å–å›¾åƒé¡¹ï¼ˆpixmap_itemï¼‰çš„è¾¹ç•ŒçŸ©å½¢
3. è®¡ç®—ç¼©æ”¾æ¯”ä¾‹ï¼ˆä¿æŒå®½é«˜æ¯”ï¼‰:
   ```
   scale_x = view_width / image_width
   scale_y = view_height / image_height
   scale = min(scale_x, scale_y)  # å–è¾ƒå°å€¼ï¼Œä¿è¯å®Œæ•´æ˜¾ç¤º
   ```
4. åº”ç”¨å˜æ¢çŸ©é˜µ
5. å±…ä¸­æ˜¾ç¤º

**KeepAspectRatioçš„ä½œç”¨**:
- ä¿æŒå›¾åƒå®½é«˜æ¯”
- é¿å…å›¾åƒå˜å½¢
- å®Œæ•´æ˜¾ç¤ºå›¾åƒï¼ˆä¸è£å‰ªï¼‰

#### 3. æ¸…é™¤å’Œé‡æ–°æ·»åŠ 

```python
self.graphics_scene.clear()  # æ¸…é™¤æ—§å›¾åƒ
pixmap_item = self.graphics_scene.addPixmap(self.current_pixmap)  # æ·»åŠ æ–°å›¾åƒ
```

**ä¸ºä»€ä¹ˆéœ€è¦clear()ï¼Ÿ**
- æ¸…é™¤åœºæ™¯ä¸­çš„æ—§å›¾åƒé¡¹
- é¿å…å†…å­˜æ³„æ¼
- ç¡®ä¿åœºæ™¯å¹²å‡€

---

## ğŸ” åŠŸèƒ½5ï¼šå…¨å±æ˜¾ç¤º

### å®ç°åŸç†

åˆ›å»ºç‹¬ç«‹çš„**å…¨å±å¯¹è¯æ¡†**ï¼Œä½¿ç”¨æ–°çš„`QGraphicsView`å’Œ`QGraphicsScene`æ˜¾ç¤ºå›¾åƒã€‚

### ä»£ç å®ç°

**ä½ç½®**: `ui/components/image_preview_widget.py` (186-209è¡Œ)

```python
def show_fullscreen(self):
    """å…¨å±æ˜¾ç¤º"""
    # 1. æ£€æŸ¥æ˜¯å¦æœ‰å›¾åƒ
    if self.current_image_array is None:
        return
    
    # 2. å¯¼å…¥å¿…è¦çš„ç±»
    from PySide6.QtWidgets import QDialog, QVBoxLayout, QGraphicsView, QGraphicsScene
    
    # 3. åˆ›å»ºå…¨å±å¯¹è¯æ¡†
    dialog = QDialog(self)
    dialog.setWindowTitle("å…¨å±é¢„è§ˆ")
    dialog.setWindowState(Qt.WindowState.WindowFullScreen)
    
    # 4. åˆ›å»ºå¸ƒå±€
    layout = QVBoxLayout(dialog)
    
    # 5. åˆ›å»ºæ–°çš„è§†å›¾å’Œåœºæ™¯ï¼ˆç‹¬ç«‹äºä¸»è§†å›¾ï¼‰
    fullscreen_view = QGraphicsView()
    fullscreen_scene = QGraphicsScene()
    fullscreen_view.setScene(fullscreen_scene)
    
    # 6. æ˜¾ç¤ºå›¾åƒ
    if self.current_pixmap:
        # ä½¿ç”¨åŸå§‹pixmapï¼ˆä¿æŒè´¨é‡ï¼‰
        pixmap_item = fullscreen_scene.addPixmap(self.current_pixmap)
        
        # è‡ªé€‚åº”æ˜¾ç¤ºï¼ˆå¡«å……æ•´ä¸ªå±å¹•ï¼Œä¿æŒå®½é«˜æ¯”ï¼‰
        fullscreen_view.fitInView(
            pixmap_item, 
            Qt.AspectRatioMode.KeepAspectRatio
        )
    
    # 7. æ·»åŠ åˆ°å¸ƒå±€
    layout.addWidget(fullscreen_view)
    
    # 8. æ¨¡æ€æ˜¾ç¤ºï¼ˆé˜»å¡ç›´åˆ°å…³é—­ï¼‰
    dialog.exec()
```

### å…³é”®æŠ€æœ¯ç‚¹

#### 1. å…¨å±çª—å£è®¾ç½®

```python
dialog.setWindowState(Qt.WindowState.WindowFullScreen)
```

**ä½œç”¨**:
- è®¾ç½®çª—å£ä¸ºå…¨å±çŠ¶æ€
- éšè—ä»»åŠ¡æ å’Œçª—å£è¾¹æ¡†
- å æ®æ•´ä¸ªå±å¹•

#### 2. ç‹¬ç«‹è§†å›¾å’Œåœºæ™¯

```python
fullscreen_view = QGraphicsView()  # æ–°çš„è§†å›¾
fullscreen_scene = QGraphicsScene()  # æ–°çš„åœºæ™¯
```

**ä¸ºä»€ä¹ˆåˆ›å»ºæ–°çš„ï¼Ÿ**
- âœ… ç‹¬ç«‹äºä¸»è§†å›¾ï¼Œä¸å½±å“ä¸»çª—å£
- âœ… å¯ä»¥æœ‰ä¸åŒçš„ç¼©æ”¾çŠ¶æ€
- âœ… å…³é—­å¯¹è¯æ¡†æ—¶è‡ªåŠ¨æ¸…ç†

#### 3. ä½¿ç”¨åŸå§‹pixmap

```python
if self.current_pixmap:
    pixmap_item = fullscreen_scene.addPixmap(self.current_pixmap)
```

**ä¼˜åŠ¿**:
- ä½¿ç”¨ç¼“å­˜çš„pixmapï¼Œä¸é‡æ–°è½¬æ¢
- ä¿æŒå›¾åƒè´¨é‡
- æ€§èƒ½å¥½

#### 4. æ¨¡æ€å¯¹è¯æ¡†

```python
dialog.exec()  # æ¨¡æ€æ˜¾ç¤º
```

**ä½œç”¨**:
- é˜»å¡ä¸»çª—å£ï¼Œç›´åˆ°å¯¹è¯æ¡†å…³é—­
- ç”¨æˆ·ä¸“æ³¨äºå…¨å±é¢„è§ˆ
- å…³é—­æ—¶è‡ªåŠ¨æ¸…ç†èµ„æº

---

## ğŸ” åŠŸèƒ½6ï¼šæ‹–æ‹½å¹³ç§»

### å®ç°åŸç†

ä½¿ç”¨Qtçš„**ScrollHandDrag**æ¨¡å¼ï¼Œè‡ªåŠ¨å®ç°æ‹–æ‹½å¹³ç§»åŠŸèƒ½ã€‚

### ä»£ç å®ç°

**ä½ç½®**: `ui/components/image_preview_widget.py` (52è¡Œ)

```python
self.graphics_view.setDragMode(QGraphicsView.DragMode.ScrollHandDrag)
```

### å·¥ä½œåŸç†

**ScrollHandDragæ¨¡å¼**:
1. ç”¨æˆ·æŒ‰ä¸‹é¼ æ ‡å·¦é”®å¹¶æ‹–åŠ¨
2. Qtè‡ªåŠ¨è®¡ç®—é¼ æ ‡ç§»åŠ¨è·ç¦»
3. åº”ç”¨å¹³ç§»å˜æ¢åˆ°è§†å›¾
4. å›¾åƒè·Ÿéšé¼ æ ‡ç§»åŠ¨

**å˜æ¢çŸ©é˜µ**:
```
å¹³ç§»å‰: [1  0  0]
        [0  1  0]
        [0  0  1]

å¹³ç§»å: [1  0  dx]
        [0  1  dy]
        [0  0  1]
```

### å…³é”®æŠ€æœ¯ç‚¹

#### æ‹–æ‹½æ¨¡å¼å¯¹æ¯”

| æ¨¡å¼ | è¯´æ˜ | é€‚ç”¨åœºæ™¯ |
|------|------|----------|
| `NoDrag` | æ— æ‹–æ‹½ | é»˜è®¤æ¨¡å¼ |
| `ScrollHandDrag` | æ‰‹å‹æ‹–æ‹½ | **å›¾åƒé¢„è§ˆ** âœ“ |
| `RubberBandDrag` | æ¡†é€‰æ‹–æ‹½ | é€‰æ‹©åŒºåŸŸ |

**ä¸ºä»€ä¹ˆé€‰æ‹©ScrollHandDragï¼Ÿ**
- âœ… æä¾›æ‰‹å‹å…‰æ ‡ï¼Œç”¨æˆ·ä½“éªŒå¥½
- âœ… è‡ªåŠ¨å¤„ç†æ‹–æ‹½é€»è¾‘
- âœ… ä¸ç¼©æ”¾åŠŸèƒ½å®Œç¾é…åˆ

---

## ğŸ”„ è§†å›¾å˜æ¢ç®¡ç†

### å˜æ¢çŸ©é˜µçš„ç´¯ç§¯

Qtçš„`QGraphicsView`ä½¿ç”¨**å˜æ¢çŸ©é˜µ**ç®¡ç†è§†å›¾å˜æ¢ï¼š

```python
# åˆå§‹çŠ¶æ€
transform = [1, 0, 0,
             0, 1, 0,
             0, 0, 1]

# æ”¾å¤§1.2å€
transform = scale(transform, 1.2, 1.2)

# å†æ”¾å¤§1.2å€
transform = scale(transform, 1.2, 1.2)
# ç»“æœï¼š1.2 Ã— 1.2 = 1.44å€

# å¤ä½
transform = reset()  # æ¢å¤ä¸ºå•ä½çŸ©é˜µ
```

### ç¼©æ”¾å› å­çš„è·Ÿè¸ª

```python
self.zoom_factor = 1.0  # åˆå§‹ç¼©æ”¾å› å­

# æ¯æ¬¡ç¼©æ”¾åæ›´æ–°
self.zoom_factor = self.zoom_factor * scale_factor
```

**ä½œç”¨**:
- è·Ÿè¸ªå½“å‰ç¼©æ”¾æ¯”ä¾‹
- ç”¨äºçŠ¶æ€æ˜¾ç¤º
- ç”¨äºç¼©æ”¾é™åˆ¶æ£€æŸ¥

### å˜æ¢çš„ç´¯ç§¯æ€§

```python
# ç¬¬ä¸€æ¬¡ç¼©æ”¾ï¼š1.2å€
self.graphics_view.scale(1.2, 1.2)  # zoom_factor = 1.2

# ç¬¬äºŒæ¬¡ç¼©æ”¾ï¼šå†1.2å€
self.graphics_view.scale(1.2, 1.2)  # zoom_factor = 1.44

# ç¬¬ä¸‰æ¬¡ç¼©æ”¾ï¼šå†1.2å€
self.graphics_view.scale(1.2, 1.2)  # zoom_factor = 1.728
```

**æ³¨æ„**:
- å˜æ¢æ˜¯**ç´¯ç§¯çš„**
- æ¯æ¬¡`scale()`éƒ½ä¼šåœ¨ç°æœ‰å˜æ¢åŸºç¡€ä¸Šå åŠ 
- `resetTransform()`ä¼šæ¸…é™¤æ‰€æœ‰ç´¯ç§¯çš„å˜æ¢

---

## ğŸ¯ å®Œæ•´äº¤äº’æµç¨‹

### ç”¨æˆ·æ“ä½œæµç¨‹

```
1. ç”¨æˆ·ç‚¹å‡»"ç”Ÿæˆé¢„è§ˆ"
   â†“
2. åå°çº¿ç¨‹ç”Ÿæˆå›¾åƒ
   â†“
3. update_image()è¢«è°ƒç”¨
   â†“
4. å›¾åƒæ˜¾ç¤ºï¼ˆè‡ªé€‚åº”ï¼‰
   â†“
5. ç”¨æˆ·äº¤äº’ï¼š
   â”œâ”€ ç‚¹å‡»"æ”¾å¤§" â†’ zoom_in() â†’ scale(1.2, 1.2)
   â”œâ”€ ç‚¹å‡»"ç¼©å°" â†’ zoom_out() â†’ scale(1/1.2, 1/1.2)
   â”œâ”€ æ»šè½®å‘ä¸Š â†’ _on_wheel_event() â†’ scale(1.15, 1.15)
   â”œâ”€ æ»šè½®å‘ä¸‹ â†’ _on_wheel_event() â†’ scale(1/1.15, 1/1.15)
   â”œâ”€ æ‹–æ‹½å›¾åƒ â†’ ScrollHandDragè‡ªåŠ¨å¤„ç†
   â”œâ”€ ç‚¹å‡»"å¤ä½" â†’ reset_view() â†’ resetTransform() + fitInView()
   â””â”€ ç‚¹å‡»"å…¨å±" â†’ show_fullscreen() â†’ åˆ›å»ºå…¨å±å¯¹è¯æ¡†
```

---

## ğŸ’¡ å…³é”®æŠ€æœ¯ç»†èŠ‚

### 1. ç¼©æ”¾ä¸­å¿ƒç‚¹çš„è®¡ç®—

**Qtå†…éƒ¨å®ç°**ï¼ˆç®€åŒ–ç‰ˆï¼‰:

```python
def scale_at_point(view, scale_factor, mouse_pos):
    """ä»¥æŒ‡å®šç‚¹ä¸ºä¸­å¿ƒç¼©æ”¾"""
    # 1. å°†é¼ æ ‡ä½ç½®è½¬æ¢ä¸ºåœºæ™¯åæ ‡
    scene_pos = view.mapToScene(mouse_pos)
    
    # 2. åº”ç”¨ç¼©æ”¾
    view.scale(scale_factor, scale_factor)
    
    # 3. è®¡ç®—ç¼©æ”¾åçš„é¼ æ ‡ä½ç½®
    new_scene_pos = view.mapToScene(mouse_pos)
    
    # 4. è®¡ç®—åç§»é‡
    offset = scene_pos - new_scene_pos
    
    # 5. å¹³ç§»è§†å›¾ï¼Œä½¿é¼ æ ‡ä½ç½®ä¿æŒä¸å˜
    view.translate(offset.x(), offset.y())
```

**AnchorUnderMouseçš„ä½œç”¨**:
- Qtè‡ªåŠ¨æ‰§è¡Œä¸Šè¿°è®¡ç®—
- ç”¨æˆ·æ— éœ€æ‰‹åŠ¨å¤„ç†
- æä¾›å¹³æ»‘çš„ç¼©æ”¾ä½“éªŒ

### 2. fitInView()çš„ç®—æ³•ç»†èŠ‚

**Qtå†…éƒ¨å®ç°**ï¼ˆç®€åŒ–ç‰ˆï¼‰:

```python
def fitInView(item, aspect_ratio_mode):
    """è‡ªé€‚åº”æ˜¾ç¤º"""
    # 1. è·å–è§†å›¾å¯ç”¨åŒºåŸŸ
    view_rect = view.viewport().rect()
    view_width = view_rect.width()
    view_height = view_rect.height()
    
    # 2. è·å–å›¾åƒè¾¹ç•Œ
    item_rect = item.boundingRect()
    image_width = item_rect.width()
    image_height = item_rect.height()
    
    # 3. è®¡ç®—ç¼©æ”¾æ¯”ä¾‹
    scale_x = view_width / image_width
    scale_y = view_height / image_height
    
    if aspect_ratio_mode == KeepAspectRatio:
        # ä¿æŒå®½é«˜æ¯”ï¼Œå–è¾ƒå°å€¼
        scale = min(scale_x, scale_y)
    else:
        # ä¸ä¿æŒå®½é«˜æ¯”
        scale_x, scale_y = scale_x, scale_y
    
    # 4. é‡ç½®å˜æ¢
    view.resetTransform()
    
    # 5. åº”ç”¨ç¼©æ”¾
    view.scale(scale, scale)
    
    # 6. å±…ä¸­æ˜¾ç¤º
    view.centerOn(item)
```

### 3. äº‹ä»¶å¤„ç†çš„ä¼˜å…ˆçº§

```python
# äº‹ä»¶å¤„ç†é¡ºåº
1. é¼ æ ‡æ»šè½®äº‹ä»¶ â†’ _on_wheel_event() â†’ ç¼©æ”¾
2. åŒå‡»äº‹ä»¶ â†’ _on_double_click() â†’ å…¨å±
3. æ‹–æ‹½äº‹ä»¶ â†’ ScrollHandDrag â†’ å¹³ç§»
4. æŒ‰é’®ç‚¹å‡» â†’ zoom_in/zoom_out/reset â†’ ç¼©æ”¾/å¤ä½
```

**äº‹ä»¶æ‹¦æˆª**:
- æ»šè½®äº‹ä»¶è¢«è‡ªå®šä¹‰å¤„ç†ï¼Œä¸ä¼šè§¦å‘é»˜è®¤æ»šåŠ¨
- åŒå‡»äº‹ä»¶è¢«æ‹¦æˆªï¼Œä¸ä¼šè§¦å‘é€‰æ‹©

### 4. çŠ¶æ€åŒæ­¥

```python
def _update_zoom_status(self):
    """æ›´æ–°ç¼©æ”¾çŠ¶æ€æ˜¾ç¤º"""
    # ä»çŠ¶æ€æ ‡ç­¾ä¸­æå–ä¿¡æ¯
    current_text = self.status_label.text()
    
    # æ›¿æ¢ç¼©æ”¾ç™¾åˆ†æ¯”
    if " | ç¼©æ”¾:" in current_text:
        parts = current_text.split(" | ç¼©æ”¾:")
        # ä¿ç•™å…¶ä»–ä¿¡æ¯ï¼Œåªæ›´æ–°ç¼©æ”¾ç™¾åˆ†æ¯”
        new_text = f"{parts[0]} | ç¼©æ”¾: {int(self.zoom_factor*100)}%{remaining}"
        self.status_label.setText(new_text)
```

**ä½œç”¨**:
- å®æ—¶æ˜¾ç¤ºå½“å‰ç¼©æ”¾æ¯”ä¾‹
- æä¾›ç”¨æˆ·åé¦ˆ
- å¸®åŠ©ç”¨æˆ·äº†è§£å½“å‰çŠ¶æ€

---

## ğŸ”§ åœ¨å…¶ä»–é¡¹ç›®ä¸­å®ç°

### æœ€å°å®ç°ï¼ˆæ ¸å¿ƒä»£ç ï¼‰

```python
from PySide6.QtWidgets import (
    QWidget, QVBoxLayout, QGraphicsView, QGraphicsScene, QPushButton
)
from PySide6.QtGui import QPixmap, QImage, QWheelEvent
from PySide6.QtCore import Qt
import numpy as np

class SimpleImagePreview(QWidget):
    def __init__(self):
        super().__init__()
        self.zoom_factor = 1.0
        self.min_zoom = 0.25
        self.max_zoom = 4.0
        
        # åˆ›å»ºè§†å›¾å’Œåœºæ™¯
        self.view = QGraphicsView()
        self.scene = QGraphicsScene()
        self.view.setScene(self.scene)
        
        # å…³é”®è®¾ç½®
        self.view.setRenderHint(QPainter.RenderHint.Antialiasing)
        self.view.setDragMode(QGraphicsView.DragMode.ScrollHandDrag)
        self.view.setTransformationAnchor(QGraphicsView.ViewportAnchor.AnchorUnderMouse)
        
        # ç»‘å®šäº‹ä»¶
        self.view.wheelEvent = self._on_wheel
        
        # æŒ‰é’®
        zoom_in_btn = QPushButton("æ”¾å¤§")
        zoom_in_btn.clicked.connect(self.zoom_in)
        
        zoom_out_btn = QPushButton("ç¼©å°")
        zoom_out_btn.clicked.connect(self.zoom_out)
        
        reset_btn = QPushButton("å¤ä½")
        reset_btn.clicked.connect(self.reset)
        
        # å¸ƒå±€
        layout = QVBoxLayout(self)
        layout.addWidget(self.view)
        layout.addWidget(zoom_in_btn)
        layout.addWidget(zoom_out_btn)
        layout.addWidget(reset_btn)
    
    def update_image(self, img_array: np.ndarray):
        """æ›´æ–°å›¾åƒ"""
        # è½¬æ¢ä¸ºQImage
        if img_array.dtype != np.uint8:
            img_array = np.clip(img_array, 0, 255).astype(np.uint8)
        
        height, width = img_array.shape
        q_image = QImage(img_array.data, width, height, width, QImage.Format.Format_Grayscale8)
        pixmap = QPixmap.fromImage(q_image)
        
        # æ˜¾ç¤º
        self.scene.clear()
        item = self.scene.addPixmap(pixmap)
        self.view.fitInView(item, Qt.AspectRatioMode.KeepAspectRatio)
        self.zoom_factor = 1.0
    
    def zoom_in(self):
        """æ”¾å¤§"""
        scale = 1.2
        new_zoom = min(self.max_zoom, self.zoom_factor * scale)
        if new_zoom != self.zoom_factor:
            self.zoom_factor = new_zoom
            self.view.scale(scale, scale)
    
    def zoom_out(self):
        """ç¼©å°"""
        scale = 1.0 / 1.2
        new_zoom = max(self.min_zoom, self.zoom_factor * scale)
        if new_zoom != self.zoom_factor:
            self.zoom_factor = new_zoom
            self.view.scale(scale, scale)
    
    def reset(self):
        """å¤ä½"""
        self.zoom_factor = 1.0
        self.view.resetTransform()
        items = self.scene.items()
        if items:
            self.view.fitInView(items[0], Qt.AspectRatioMode.KeepAspectRatio)
    
    def _on_wheel(self, event: QWheelEvent):
        """æ»šè½®ç¼©æ”¾"""
        delta = event.angleDelta().y()
        scale = 1.15 if delta > 0 else 1.0 / 1.15
        new_zoom = max(self.min_zoom, min(self.max_zoom, self.zoom_factor * scale))
        if new_zoom != self.zoom_factor:
            self.zoom_factor = new_zoom
            self.view.scale(scale, scale)
```

---

## ğŸ“Š æ€§èƒ½ä¼˜åŒ–

### 1. å˜æ¢çŸ©é˜µç¼“å­˜

Qtå†…éƒ¨ä¼šç¼“å­˜å˜æ¢çŸ©é˜µï¼Œé¿å…é‡å¤è®¡ç®—ï¼š
- åªåœ¨è°ƒç”¨`scale()`æ—¶é‡æ–°è®¡ç®—
- æ¸²æŸ“æ—¶ç›´æ¥ä½¿ç”¨ç¼“å­˜çš„çŸ©é˜µ

### 2. åœºæ™¯æ›´æ–°ä¼˜åŒ–

```python
self.graphics_scene.clear()  # æ¸…é™¤æ—§é¡¹
pixmap_item = self.graphics_scene.addPixmap(self.current_pixmap)  # æ·»åŠ æ–°é¡¹
```

**ä¼˜åŠ¿**:
- åªæ›´æ–°å¿…è¦çš„é¡¹
- é¿å…åœºæ™¯ä¸­ç§¯ç´¯è¿‡å¤šé¡¹
- å‡å°‘å†…å­˜å ç”¨

### 3. Pixmapç¼“å­˜

```python
self.current_pixmap = QPixmap.fromImage(q_image)
```

**ä¼˜åŠ¿**:
- QPixmapæ˜¯Qtçš„ä¼˜åŒ–æ ¼å¼
- é€‚åˆé¢‘ç¹ç»˜åˆ¶
- æ”¯æŒç¡¬ä»¶åŠ é€Ÿ

---

## ğŸ¯ å®ç°"å®Œç¾äº¤äº’"çš„å…³é”®æŠ€æœ¯

### 1. ç¼©æ”¾ä¸­å¿ƒç‚¹

```python
self.graphics_view.setTransformationAnchor(
    QGraphicsView.ViewportAnchor.AnchorUnderMouse
)
```

**ä½œç”¨**: ä»¥é¼ æ ‡ä½ç½®ä¸ºä¸­å¿ƒç¼©æ”¾ï¼Œæä¾›è‡ªç„¶çš„äº¤äº’ä½“éªŒ

### 2. æ‹–æ‹½æ¨¡å¼

```python
self.graphics_view.setDragMode(QGraphicsView.DragMode.ScrollHandDrag)
```

**ä½œç”¨**: è‡ªåŠ¨å®ç°æ‹–æ‹½å¹³ç§»ï¼Œæ— éœ€æ‰‹åŠ¨å¤„ç†é¼ æ ‡äº‹ä»¶

### 3. è‡ªé€‚åº”æ˜¾ç¤º

```python
self.graphics_view.fitInView(
    pixmap_item, 
    Qt.AspectRatioMode.KeepAspectRatio
)
```

**ä½œç”¨**: è‡ªåŠ¨è°ƒæ•´å¤§å°ï¼Œä¿æŒå®½é«˜æ¯”ï¼Œå®Œæ•´æ˜¾ç¤º

### 4. ç¼©æ”¾é™åˆ¶

```python
new_zoom = max(self.min_zoom, min(self.max_zoom, new_zoom))
```

**ä½œç”¨**: é˜²æ­¢è¿‡åº¦ç¼©æ”¾ï¼Œä¿æŠ¤æ€§èƒ½å’Œç”¨æˆ·ä½“éªŒ

### 5. çŠ¶æ€åŒæ­¥

```python
self.zoom_factor = new_zoom  # è·Ÿè¸ªç¼©æ”¾å› å­
self._update_zoom_status()   # æ›´æ–°UIæ˜¾ç¤º
```

**ä½œç”¨**: å®æ—¶åé¦ˆï¼Œè®©ç”¨æˆ·äº†è§£å½“å‰çŠ¶æ€

---

## ğŸ“Œ æ€»ç»“

### å®ç°å®Œç¾äº¤äº’çš„5ä¸ªå…³é”®æŠ€æœ¯

1. âœ… **ç¼©æ”¾ä¸­å¿ƒç‚¹**: `AnchorUnderMouse` - ä»¥é¼ æ ‡ä¸ºä¸­å¿ƒç¼©æ”¾
2. âœ… **æ‹–æ‹½æ¨¡å¼**: `ScrollHandDrag` - è‡ªåŠ¨å®ç°å¹³ç§»
3. âœ… **è‡ªé€‚åº”æ˜¾ç¤º**: `fitInView` - è‡ªåŠ¨è°ƒæ•´å¤§å°
4. âœ… **ç¼©æ”¾é™åˆ¶**: é™åˆ¶èŒƒå›´ï¼Œä¿æŠ¤æ€§èƒ½
5. âœ… **çŠ¶æ€åŒæ­¥**: å®æ—¶æ›´æ–°UIï¼Œæä¾›åé¦ˆ

### æ ¸å¿ƒAPI

- `QGraphicsView.scale(sx, sy)`: åº”ç”¨ç¼©æ”¾å˜æ¢
- `QGraphicsView.resetTransform()`: é‡ç½®å˜æ¢çŸ©é˜µ
- `QGraphicsView.fitInView(item, mode)`: è‡ªé€‚åº”æ˜¾ç¤º
- `QGraphicsView.setDragMode(mode)`: è®¾ç½®æ‹–æ‹½æ¨¡å¼
- `QGraphicsView.setTransformationAnchor(anchor)`: è®¾ç½®å˜æ¢é”šç‚¹

### æŠ€æœ¯æ ˆ

- **Qt Graphics Framework**: QGraphicsView/QGraphicsScene
- **äº‹ä»¶å¤„ç†**: é‡å†™wheelEventå’ŒmouseDoubleClickEvent
- **å˜æ¢ç®¡ç†**: å˜æ¢çŸ©é˜µå’Œç¼©æ”¾å› å­è·Ÿè¸ª

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
**æœ€åæ›´æ–°**: 2024å¹´

