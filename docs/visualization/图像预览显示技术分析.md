# å›¾åƒé¢„è§ˆæ˜¾ç¤ºæŠ€æœ¯åˆ†æ

## ğŸ“‹ æ¦‚è¿°

æœ¬æ–‡æ¡£è¯¦ç»†åˆ†æLGå…¨æ¯å›¾ç”Ÿæˆè½¯ä»¶ä¸­äº¤äº’å¼è®¾è®¡é¡µé¢çš„ç›¸ä½å›¾å’Œå…¨æ¯å›¾é¢„è§ˆåŠŸèƒ½çš„æŠ€æœ¯å®ç°ï¼Œé‡ç‚¹è¯´æ˜å¦‚ä½•å®ç°**å®Œç¾çš„å›¾åƒæ˜¾ç¤ºæ•ˆæœ**ã€‚

---

## ğŸ—ï¸ æŠ€æœ¯æ¶æ„

### æ•´ä½“æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         InteractiveDesignPage                    â”‚
â”‚  - ç”Ÿæˆé¢„è§ˆæŒ‰é’®                                  â”‚
â”‚  - åå°çº¿ç¨‹ç”Ÿæˆ                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â”‚ ä¼ é€’numpyæ•°ç»„
                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         ImagePreviewWidget                      â”‚
â”‚  - update_image(numpyæ•°ç»„)                       â”‚
â”‚  - æ•°æ®è½¬æ¢å’Œä¼˜åŒ–                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â”‚ NumPy â†’ QImage â†’ QPixmap
                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         QGraphicsView + QGraphicsScene           â”‚
â”‚  - æŠ—é”¯é½¿æ¸²æŸ“                                     â”‚
â”‚  - è‡ªé€‚åº”ç¼©æ”¾                                     â”‚
â”‚  - äº¤äº’åŠŸèƒ½ï¼ˆç¼©æ”¾ã€å¹³ç§»ã€å…¨å±ï¼‰                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”‘ æ ¸å¿ƒæŠ€æœ¯ç‚¹

### 1. æ•°æ®è½¬æ¢é“¾è·¯

#### å®Œæ•´è½¬æ¢æµç¨‹

```
ç®—æ³•ç”Ÿæˆ (numpyæ•°ç»„, float64)
    â†“
æ•°å€¼ä¿æŠ¤ (NaN/Infå¤„ç†)
    â†“
å½’ä¸€åŒ–åˆ°[0, 2Ï€]
    â†“
æ˜ å°„åˆ°[0, 255]
    â†“
è½¬æ¢ä¸ºuint8
    â†“
NumPyæ•°ç»„ (uint8, shape: [H, V])
    â†“
QImage (Format_Grayscale8)
    â†“
QPixmap (ç”¨äºæ˜¾ç¤º)
    â†“
QGraphicsScene (åœºæ™¯)
    â†“
QGraphicsView (è§†å›¾ï¼Œå¸¦æŠ—é”¯é½¿)
```

#### å…³é”®ä»£ç å®ç°

**ä½ç½®**: `ui/components/image_preview_widget.py`

```python
def update_image(self, img_array: np.ndarray, status_text: str = ""):
    """æ›´æ–°æ˜¾ç¤ºçš„å›¾åƒ"""
    # 1. æ•°æ®ç±»å‹è½¬æ¢å’Œè£å‰ª
    if img_array.dtype != np.uint8:
        img_array = np.clip(img_array, 0, 255).astype(np.uint8)
    
    # 2. ä¿å­˜åŸå§‹æ•°æ®ï¼ˆç”¨äºå…¨å±æ˜¾ç¤ºï¼‰
    self.current_image_array = img_array.copy()
    
    # 3. NumPyæ•°ç»„ â†’ QImageï¼ˆé›¶æ‹·è´è½¬æ¢ï¼‰
    height, width = img_array.shape
    bytes_per_line = width  # ç°åº¦å›¾æ¯è¡Œå­—èŠ‚æ•° = å®½åº¦
    q_image = QImage(
        img_array.data,        # ç›´æ¥ä½¿ç”¨numpyæ•°ç»„çš„æ•°æ®æŒ‡é’ˆ
        width,                  # å›¾åƒå®½åº¦
        height,                 # å›¾åƒé«˜åº¦
        bytes_per_line,         # æ¯è¡Œå­—èŠ‚æ•°
        QImage.Format.Format_Grayscale8  # 8ä½ç°åº¦æ ¼å¼
    )
    
    # 4. QImage â†’ QPixmapï¼ˆç”¨äºé«˜æ•ˆæ¸²æŸ“ï¼‰
    self.current_pixmap = QPixmap.fromImage(q_image)
    
    # 5. é‡ç½®è§†å›¾å¹¶è‡ªé€‚åº”æ˜¾ç¤º
    self.reset_view()
```

**å…³é”®æŠ€æœ¯ç‚¹**:
- âœ… **é›¶æ‹·è´è½¬æ¢**ï¼šç›´æ¥ä½¿ç”¨numpyæ•°ç»„çš„æ•°æ®æŒ‡é’ˆï¼Œé¿å…æ•°æ®å¤åˆ¶
- âœ… **æ ¼å¼åŒ¹é…**ï¼šä½¿ç”¨`Format_Grayscale8`ï¼Œå®Œç¾åŒ¹é…8ä½ç°åº¦å›¾
- âœ… **æ•°æ®ç±»å‹ä¿è¯**ï¼šç¡®ä¿è¾“å…¥ä¸ºuint8ï¼Œé¿å…æ˜¾ç¤ºå¼‚å¸¸

---

### 2. æ•°å€¼å¤„ç†å’Œå½’ä¸€åŒ–

#### ç®—æ³•å±‚çš„æ•°å€¼å¤„ç†

**ä½ç½®**: `infrastructure/algorithms/generatePhase_G_direct.py` (152-153è¡Œ)

```python
# æ•°å€¼ä¿æŠ¤ï¼šå¤„ç†NaNå’ŒInf
holograms_0 = np.nan_to_num(holograms_0, nan=0.0, posinf=2*np.pi, neginf=0.0)
phase = np.nan_to_num(phase, nan=0.0, posinf=2*np.pi, neginf=0.0)

# å½’ä¸€åŒ–åˆ°[0, 255]å¹¶è½¬æ¢ä¸ºuint8
holograms = np.uint8(np.clip(255.0 * holograms_0 / (2.0 * np.pi), 0, 255))
phase_map = np.uint8(np.clip(255.0 * phase / (2.0 * np.pi), 0, 255))
```

**å¤„ç†æ­¥éª¤**:
1. **NaN/Infä¿æŠ¤**ï¼šå°†å¼‚å¸¸å€¼æ›¿æ¢ä¸ºå®‰å…¨å€¼
2. **å½’ä¸€åŒ–**ï¼šå°†ç›¸ä½å€¼[0, 2Ï€]æ˜ å°„åˆ°[0, 255]
3. **è£å‰ª**ï¼šç¡®ä¿å€¼åœ¨æœ‰æ•ˆèŒƒå›´å†…
4. **ç±»å‹è½¬æ¢**ï¼šè½¬æ¢ä¸ºuint8

**ä¼˜åŠ¿**:
- âœ… é¿å…æ˜¾ç¤ºå¼‚å¸¸ï¼ˆé»‘å±ã€ç™½å±ï¼‰
- âœ… ä¿è¯æ•°å€¼èŒƒå›´æ­£ç¡®
- âœ… ç›¸ä½ä¿¡æ¯å®Œæ•´ä¿ç•™

---

### 3. æ¸²æŸ“ä¼˜åŒ–

#### æŠ—é”¯é½¿æ¸²æŸ“

**ä½ç½®**: `ui/components/image_preview_widget.py` (51è¡Œ)

```python
self.graphics_view.setRenderHint(QPainter.RenderHint.Antialiasing)
```

**ä½œç”¨**:
- å¯ç”¨æŠ—é”¯é½¿ï¼Œä½¿å›¾åƒè¾¹ç¼˜æ›´å¹³æ»‘
- ç¼©æ”¾æ—¶å‡å°‘é”¯é½¿æ•ˆåº”
- æå‡è§†è§‰è´¨é‡

#### è‡ªé€‚åº”æ˜¾ç¤º

**ä½ç½®**: `ui/components/image_preview_widget.py` (175-184è¡Œ)

```python
def reset_view(self):
    """é‡ç½®è§†å›¾"""
    self.zoom_factor = 1.0
    self.graphics_view.resetTransform()
    
    if self.current_pixmap:
        self.graphics_scene.clear()
        pixmap_item = self.graphics_scene.addPixmap(self.current_pixmap)
        # è‡ªé€‚åº”ç¼©æ”¾ï¼Œä¿æŒå®½é«˜æ¯”
        self.graphics_view.fitInView(
            pixmap_item, 
            Qt.AspectRatioMode.KeepAspectRatio
        )
        self._update_zoom_status()
```

**å…³é”®æŠ€æœ¯**:
- âœ… **fitInView()**ï¼šè‡ªåŠ¨è°ƒæ•´è§†å›¾å¤§å°ï¼Œä½¿å›¾åƒå®Œæ•´æ˜¾ç¤º
- âœ… **KeepAspectRatio**ï¼šä¿æŒå®½é«˜æ¯”ï¼Œé¿å…å›¾åƒå˜å½¢
- âœ… **resetTransform()**ï¼šé‡ç½®å˜æ¢çŸ©é˜µï¼Œç¡®ä¿ç¼©æ”¾ä»1.0å¼€å§‹

---

### 4. äº¤äº’åŠŸèƒ½

#### é¼ æ ‡æ»šè½®ç¼©æ”¾

**ä½ç½®**: `ui/components/image_preview_widget.py` (131-146è¡Œ)

```python
def _on_wheel_event(self, event: QWheelEvent):
    """é¼ æ ‡æ»šè½®ç¼©æ”¾"""
    if self.current_pixmap is None:
        return
    
    # è®¡ç®—ç¼©æ”¾å› å­ï¼ˆ1.15å€ï¼‰
    delta = event.angleDelta().y()
    scale_factor = 1.15 if delta > 0 else 1.0 / 1.15
    
    # é™åˆ¶ç¼©æ”¾èŒƒå›´ [0.25, 4.0]
    new_zoom = self.zoom_factor * scale_factor
    new_zoom = max(self.min_zoom, min(self.max_zoom, new_zoom))
    
    if new_zoom != self.zoom_factor:
        self.zoom_factor = new_zoom
        # ä»¥é¼ æ ‡ä½ç½®ä¸ºä¸­å¿ƒç¼©æ”¾
        self.graphics_view.scale(scale_factor, scale_factor)
        self._update_zoom_status()
```

**æŠ€æœ¯è¦ç‚¹**:
- âœ… **ç¼©æ”¾ä¸­å¿ƒ**ï¼šä»¥é¼ æ ‡ä½ç½®ä¸ºä¸­å¿ƒï¼ˆé€šè¿‡`AnchorUnderMouse`è®¾ç½®ï¼‰
- âœ… **ç¼©æ”¾æ­¥é•¿**ï¼š1.15å€ï¼Œæä¾›å¹³æ»‘çš„ç¼©æ”¾ä½“éªŒ
- âœ… **ç¼©æ”¾é™åˆ¶**ï¼š0.25x - 4.0xï¼Œé¿å…è¿‡åº¦ç¼©æ”¾

#### æ‹–æ‹½å¹³ç§»

**ä½ç½®**: `ui/components/image_preview_widget.py` (52è¡Œ)

```python
self.graphics_view.setDragMode(QGraphicsView.DragMode.ScrollHandDrag)
```

**åŠŸèƒ½**:
- å¯ç”¨æ‹–æ‹½æ¨¡å¼ï¼Œå¯ä»¥æ‹–åŠ¨å›¾åƒ
- é…åˆç¼©æ”¾åŠŸèƒ½ï¼Œå®ç°å®Œæ•´çš„å›¾åƒæµè§ˆ

#### å…¨å±æ˜¾ç¤º

**ä½ç½®**: `ui/components/image_preview_widget.py` (186-209è¡Œ)

```python
def show_fullscreen(self):
    """å…¨å±æ˜¾ç¤º"""
    if self.current_image_array is None:
        return
    
    # åˆ›å»ºå…¨å±å¯¹è¯æ¡†
    dialog = QDialog(self)
    dialog.setWindowTitle("å…¨å±é¢„è§ˆ")
    dialog.setWindowState(Qt.WindowState.WindowFullScreen)
    
    # åˆ›å»ºæ–°çš„è§†å›¾å’Œåœºæ™¯
    fullscreen_view = QGraphicsView()
    fullscreen_scene = QGraphicsScene()
    fullscreen_view.setScene(fullscreen_scene)
    
    # ä½¿ç”¨åŸå§‹pixmapï¼ˆä¿æŒè´¨é‡ï¼‰
    if self.current_pixmap:
        pixmap_item = fullscreen_scene.addPixmap(self.current_pixmap)
        fullscreen_view.fitInView(
            pixmap_item, 
            Qt.AspectRatioMode.KeepAspectRatio
        )
    
    layout.addWidget(fullscreen_view)
    dialog.exec()
```

**æŠ€æœ¯è¦ç‚¹**:
- âœ… ä½¿ç”¨åŸå§‹pixmapï¼Œä¿æŒå›¾åƒè´¨é‡
- âœ… å…¨å±è‡ªé€‚åº”æ˜¾ç¤º
- âœ… ç‹¬ç«‹å¯¹è¯æ¡†ï¼Œä¸å½±å“ä¸»çª—å£

---

## ğŸ¨ æ˜¾ç¤ºè´¨é‡ä¼˜åŒ–

### 1. æ•°æ®å®Œæ•´æ€§ä¿è¯

#### æ•°å€¼èŒƒå›´å¤„ç†

```python
# ç®—æ³•å±‚ï¼šå½’ä¸€åŒ–åˆ°[0, 2Ï€] â†’ [0, 255]
phase_map = np.uint8(np.clip(255.0 * phase / (2.0 * np.pi), 0, 255))

# UIå±‚ï¼šäºŒæ¬¡ä¿æŠ¤
if img_array.dtype != np.uint8:
    img_array = np.clip(img_array, 0, 255).astype(np.uint8)
```

**åŒé‡ä¿æŠ¤**:
- ç®—æ³•å±‚ç¡®ä¿è¾“å‡ºä¸ºuint8
- UIå±‚å†æ¬¡éªŒè¯ï¼Œé˜²æ­¢å¼‚å¸¸æ•°æ®

#### NaN/Infå¤„ç†

```python
# ç®—æ³•å±‚å¤„ç†
holograms_0 = np.nan_to_num(holograms_0, nan=0.0, posinf=2*np.pi, neginf=0.0)
```

**ä½œç”¨**:
- é¿å…NaNå¯¼è‡´çš„é»‘å±
- é¿å…Infå¯¼è‡´çš„æ˜¾ç¤ºå¼‚å¸¸
- ä¿è¯æ‰€æœ‰åƒç´ éƒ½æœ‰æœ‰æ•ˆå€¼

### 2. å†…å­˜ä¼˜åŒ–

#### é›¶æ‹·è´è½¬æ¢

```python
q_image = QImage(
    img_array.data,  # ç›´æ¥ä½¿ç”¨numpyæ•°ç»„çš„æ•°æ®æŒ‡é’ˆ
    width,
    height,
    bytes_per_line,
    QImage.Format.Format_Grayscale8
)
```

**ä¼˜åŠ¿**:
- âœ… ä¸å¤åˆ¶æ•°æ®ï¼Œç›´æ¥ä½¿ç”¨numpyæ•°ç»„å†…å­˜
- âœ… å‡å°‘å†…å­˜å ç”¨
- âœ… æå‡æ€§èƒ½

**æ³¨æ„**ï¼šéœ€è¦ç¡®ä¿numpyæ•°ç»„åœ¨QImageç”Ÿå‘½å‘¨æœŸå†…ä¿æŒæœ‰æ•ˆ

### 3. æ¸²æŸ“æ€§èƒ½ä¼˜åŒ–

#### QPixmapç¼“å­˜

```python
self.current_pixmap = QPixmap.fromImage(q_image)
```

**ä¼˜åŠ¿**:
- QPixmapæ˜¯Qtçš„ä¼˜åŒ–å›¾åƒæ ¼å¼
- é€‚åˆé¢‘ç¹ç»˜åˆ¶
- GPUåŠ é€Ÿæ”¯æŒï¼ˆå¦‚æœå¯ç”¨ï¼‰

#### åœºæ™¯ç®¡ç†

```python
self.graphics_scene.clear()  # æ¸…é™¤æ—§å›¾åƒ
pixmap_item = self.graphics_scene.addPixmap(self.current_pixmap)  # æ·»åŠ æ–°å›¾åƒ
```

**ä¼˜åŠ¿**:
- åŠæ—¶æ¸…ç†æ—§æ•°æ®ï¼Œé‡Šæ”¾å†…å­˜
- åœºæ™¯ç®¡ç†ç®€åŒ–ï¼Œæ€§èƒ½æ›´å¥½

---

## ğŸ”„ å®Œæ•´æ•°æ®æµ

### é¢„è§ˆç”Ÿæˆæµç¨‹

```
ç”¨æˆ·ç‚¹å‡»"ç”Ÿæˆé¢„è§ˆ"
    â†“
InteractiveDesignPage._generate_preview()
    â†“
åˆ›å»ºGenerationWorkerï¼ˆåå°çº¿ç¨‹ï¼‰
    â†“
GenerateSingleHologramUseCase.execute()
    â†“
ModeGenerationService.generate_hologram()
    â†“
HologramAlgorithmAdapter.generate()
    â†“
generatePhase_G_direct()
    â†“
æ•°å€¼å¤„ç†ï¼šNaN/Inf â†’ å½’ä¸€åŒ– â†’ uint8
    â†“
è¿”å› (phase_map, hologram) - numpyæ•°ç»„
    â†“
GenerationResult (å°è£…ç»“æœ)
    â†“
ä¿¡å·ï¼šGenerationWorker.finished.emit(result)
    â†“
InteractiveDesignPage._on_preview_generated()
    â†“
phase_preview.update_image(result.phase_map)
hologram_preview.update_image(result.hologram)
    â†“
ImagePreviewWidget.update_image()
    â†“
NumPyæ•°ç»„ â†’ QImage â†’ QPixmap
    â†“
QGraphicsScene.addPixmap()
    â†“
QGraphicsView.fitInView() (è‡ªé€‚åº”æ˜¾ç¤º)
    â†“
ç”¨æˆ·çœ‹åˆ°å®Œç¾æ˜¾ç¤ºçš„å›¾åƒ
```

---

## ğŸ’¡ å…³é”®æŠ€æœ¯ç»†èŠ‚

### 1. QImageæ ¼å¼é€‰æ‹©

**ä¸ºä»€ä¹ˆä½¿ç”¨`Format_Grayscale8`ï¼Ÿ**

```python
QImage.Format.Format_Grayscale8
```

**åŸå› **:
- âœ… å®Œç¾åŒ¹é…8ä½ç°åº¦å›¾ï¼ˆ0-255ï¼‰
- âœ… å†…å­˜å ç”¨å°ï¼ˆæ¯åƒç´ 1å­—èŠ‚ï¼‰
- âœ… æ˜¾ç¤ºæ€§èƒ½å¥½
- âœ… ä¸numpy uint8æ•°ç»„ä¸€ä¸€å¯¹åº”

**å…¶ä»–æ ¼å¼å¯¹æ¯”**:
- `Format_RGB32`ï¼šéœ€è¦3é€šé“ï¼Œå†…å­˜å ç”¨å¤§
- `Format_Indexed8`ï¼šéœ€è¦è°ƒè‰²æ¿ï¼Œå¤æ‚
- `Format_Grayscale8`ï¼š**æœ€ä½³é€‰æ‹©** âœ“

### 2. è‡ªé€‚åº”ç¼©æ”¾ç®—æ³•

**fitInView()çš„å·¥ä½œåŸç†**:

```python
self.graphics_view.fitInView(
    pixmap_item, 
    Qt.AspectRatioMode.KeepAspectRatio
)
```

**ç®—æ³•é€»è¾‘**:
1. è®¡ç®—è§†å›¾å¯ç”¨åŒºåŸŸå¤§å°
2. è®¡ç®—å›¾åƒåŸå§‹å¤§å°
3. è®¡ç®—ç¼©æ”¾æ¯”ä¾‹ï¼ˆä¿æŒå®½é«˜æ¯”ï¼‰
4. åº”ç”¨å˜æ¢çŸ©é˜µ
5. å±…ä¸­æ˜¾ç¤º

**ä¼˜åŠ¿**:
- âœ… è‡ªåŠ¨é€‚åº”ä¸åŒå°ºå¯¸çš„å›¾åƒ
- âœ… ä¿æŒå®½é«˜æ¯”ï¼Œä¸å˜å½¢
- âœ… å®Œæ•´æ˜¾ç¤ºï¼Œä¸è£å‰ª

### 3. ç¼©æ”¾ä¸­å¿ƒç‚¹è®¾ç½®

```python
self.graphics_view.setTransformationAnchor(
    QGraphicsView.ViewportAnchor.AnchorUnderMouse
)
self.graphics_view.setResizeAnchor(
    QGraphicsView.ViewportAnchor.AnchorUnderMouse
)
```

**ä½œç”¨**:
- ç¼©æ”¾æ—¶ä»¥é¼ æ ‡ä½ç½®ä¸ºä¸­å¿ƒ
- æä¾›æ›´è‡ªç„¶çš„äº¤äº’ä½“éªŒ
- ç”¨æˆ·å¯ä»¥ç²¾ç¡®æ§åˆ¶æŸ¥çœ‹åŒºåŸŸ

### 4. æ•°æ®æŒä¹…åŒ–

```python
self.current_image_array = img_array.copy()  # ä¿å­˜åŸå§‹æ•°ç»„
self.current_pixmap = QPixmap.fromImage(q_image)  # ä¿å­˜pixmap
```

**ä¸ºä»€ä¹ˆåŒæ—¶ä¿å­˜ï¼Ÿ**
- `current_image_array`ï¼šç”¨äºå…¨å±æ˜¾ç¤ºï¼ˆé‡æ–°ç”Ÿæˆé«˜è´¨é‡pixmapï¼‰
- `current_pixmap`ï¼šç”¨äºå¸¸è§„æ˜¾ç¤ºï¼ˆæ€§èƒ½æ›´å¥½ï¼‰

---

## ğŸ¯ å®ç°"å®Œç¾æ˜¾ç¤º"çš„å…³é”®æŠ€æœ¯

### 1. æ•°æ®ç±»å‹ä¸€è‡´æ€§

**é—®é¢˜**ï¼šä¸åŒæ•°æ®ç±»å‹ä¼šå¯¼è‡´æ˜¾ç¤ºå¼‚å¸¸

**è§£å†³æ–¹æ¡ˆ**ï¼š
```python
# ç¡®ä¿è¾“å…¥ä¸ºuint8
if img_array.dtype != np.uint8:
    img_array = np.clip(img_array, 0, 255).astype(np.uint8)
```

### 2. æ•°å€¼èŒƒå›´ä¿è¯

**é—®é¢˜**ï¼šè¶…å‡º[0, 255]èŒƒå›´ä¼šå¯¼è‡´æ˜¾ç¤ºå¼‚å¸¸

**è§£å†³æ–¹æ¡ˆ**ï¼š
```python
# åŒé‡ä¿æŠ¤
# ç®—æ³•å±‚ï¼šå½’ä¸€åŒ–åˆ°[0, 255]
holograms = np.uint8(np.clip(255.0 * holograms_0 / (2.0 * np.pi), 0, 255))

# UIå±‚ï¼šå†æ¬¡è£å‰ª
img_array = np.clip(img_array, 0, 255).astype(np.uint8)
```

### 3. å¼‚å¸¸å€¼å¤„ç†

**é—®é¢˜**ï¼šNaN/Infä¼šå¯¼è‡´é»‘å±æˆ–æ˜¾ç¤ºå¼‚å¸¸

**è§£å†³æ–¹æ¡ˆ**ï¼š
```python
# ç®—æ³•å±‚å¤„ç†
holograms_0 = np.nan_to_num(holograms_0, nan=0.0, posinf=2*np.pi, neginf=0.0)
```

### 4. æŠ—é”¯é½¿æ¸²æŸ“

**é—®é¢˜**ï¼šç¼©æ”¾æ—¶å‡ºç°é”¯é½¿

**è§£å†³æ–¹æ¡ˆ**ï¼š
```python
self.graphics_view.setRenderHint(QPainter.RenderHint.Antialiasing)
```

### 5. è‡ªé€‚åº”æ˜¾ç¤º

**é—®é¢˜**ï¼šä¸åŒå°ºå¯¸å›¾åƒæ˜¾ç¤ºä¸å®Œæ•´æˆ–å˜å½¢

**è§£å†³æ–¹æ¡ˆ**ï¼š
```python
self.graphics_view.fitInView(
    pixmap_item, 
    Qt.AspectRatioMode.KeepAspectRatio
)
```

### 6. é›¶æ‹·è´è½¬æ¢

**é—®é¢˜**ï¼šå¤§æ•°æ®é‡æ—¶å†…å­˜å ç”¨å’Œæ€§èƒ½é—®é¢˜

**è§£å†³æ–¹æ¡ˆ**ï¼š
```python
# ç›´æ¥ä½¿ç”¨numpyæ•°ç»„æ•°æ®æŒ‡é’ˆ
q_image = QImage(
    img_array.data,  # é›¶æ‹·è´
    width, height, bytes_per_line,
    QImage.Format.Format_Grayscale8
)
```

---

## ğŸ“Š æ€§èƒ½ä¼˜åŒ–

### 1. å†…å­˜ä¼˜åŒ–

- **é›¶æ‹·è´è½¬æ¢**ï¼šNumPy â†’ QImageç›´æ¥ä½¿ç”¨æ•°æ®æŒ‡é’ˆ
- **åŠæ—¶æ¸…ç†**ï¼šæ›´æ–°å›¾åƒæ—¶æ¸…é™¤æ—§åœºæ™¯
- **æŒ‰éœ€åŠ è½½**ï¼šå…¨å±æ—¶æ‰é‡æ–°ç”Ÿæˆpixmap

### 2. æ¸²æŸ“ä¼˜åŒ–

- **QPixmapç¼“å­˜**ï¼šé¿å…é‡å¤è½¬æ¢
- **æŠ—é”¯é½¿**ï¼šæå‡è§†è§‰è´¨é‡
- **ç¡¬ä»¶åŠ é€Ÿ**ï¼šQtè‡ªåŠ¨ä½¿ç”¨GPUï¼ˆå¦‚æœå¯ç”¨ï¼‰

### 3. äº¤äº’ä¼˜åŒ–

- **å¹³æ»‘ç¼©æ”¾**ï¼š1.15å€æ­¥é•¿
- **ç¼©æ”¾é™åˆ¶**ï¼šé¿å…è¿‡åº¦ç¼©æ”¾å¯¼è‡´æ€§èƒ½é—®é¢˜
- **æ‹–æ‹½ä¼˜åŒ–**ï¼šä½¿ç”¨ScrollHandDragæ¨¡å¼

---

## ğŸ”§ åœ¨å…¶ä»–é¡¹ç›®ä¸­å®ç°ç±»ä¼¼åŠŸèƒ½

### æœ€å°å®ç°ï¼ˆæ ¸å¿ƒä»£ç ï¼‰

```python
from PySide6.QtWidgets import QGraphicsView, QGraphicsScene
from PySide6.QtGui import QImage, QPixmap
from PySide6.QtCore import Qt
import numpy as np

class ImagePreviewWidget(QWidget):
    def __init__(self):
        super().__init__()
        self.graphics_view = QGraphicsView()
        self.graphics_scene = QGraphicsScene()
        self.graphics_view.setScene(self.graphics_scene)
        
        # å…³é”®è®¾ç½®
        self.graphics_view.setRenderHint(QPainter.RenderHint.Antialiasing)
        self.graphics_view.setDragMode(QGraphicsView.DragMode.ScrollHandDrag)
    
    def update_image(self, img_array: np.ndarray):
        """æ›´æ–°å›¾åƒæ˜¾ç¤º"""
        # 1. æ•°æ®ç±»å‹è½¬æ¢
        if img_array.dtype != np.uint8:
            img_array = np.clip(img_array, 0, 255).astype(np.uint8)
        
        # 2. NumPy â†’ QImageï¼ˆé›¶æ‹·è´ï¼‰
        height, width = img_array.shape
        q_image = QImage(
            img_array.data,
            width, height, width,
            QImage.Format.Format_Grayscale8
        )
        
        # 3. QImage â†’ QPixmap
        pixmap = QPixmap.fromImage(q_image)
        
        # 4. æ˜¾ç¤º
        self.graphics_scene.clear()
        pixmap_item = self.graphics_scene.addPixmap(pixmap)
        self.graphics_view.fitInView(
            pixmap_item,
            Qt.AspectRatioMode.KeepAspectRatio
        )
```

### å…³é”®è¦ç‚¹

1. **æ•°æ®ç±»å‹**ï¼šç¡®ä¿ä¸ºuint8
2. **æ•°å€¼èŒƒå›´**ï¼šç¡®ä¿åœ¨[0, 255]
3. **æ ¼å¼åŒ¹é…**ï¼šä½¿ç”¨`Format_Grayscale8`
4. **æŠ—é”¯é½¿**ï¼šå¯ç”¨`Antialiasing`
5. **è‡ªé€‚åº”**ï¼šä½¿ç”¨`fitInView`ä¿æŒå®½é«˜æ¯”

---

## ğŸ“Œ æ€»ç»“

### å®ç°"å®Œç¾æ˜¾ç¤º"çš„6ä¸ªå…³é”®æŠ€æœ¯

1. âœ… **æ•°æ®ç±»å‹ä¸€è‡´æ€§**ï¼šç¡®ä¿uint8ï¼Œé¿å…ç±»å‹é”™è¯¯
2. âœ… **æ•°å€¼èŒƒå›´ä¿è¯**ï¼šåŒé‡ä¿æŠ¤ï¼Œç¡®ä¿[0, 255]
3. âœ… **å¼‚å¸¸å€¼å¤„ç†**ï¼šNaN/Infå¤„ç†ï¼Œé¿å…æ˜¾ç¤ºå¼‚å¸¸
4. âœ… **æŠ—é”¯é½¿æ¸²æŸ“**ï¼šæå‡è§†è§‰è´¨é‡
5. âœ… **è‡ªé€‚åº”æ˜¾ç¤º**ï¼šfitInViewä¿æŒå®½é«˜æ¯”
6. âœ… **é›¶æ‹·è´è½¬æ¢**ï¼šæå‡æ€§èƒ½ï¼Œå‡å°‘å†…å­˜å ç”¨

### æŠ€æœ¯æ ˆ

- **Qt Graphics Framework**ï¼šQGraphicsView/QGraphicsScene
- **å›¾åƒæ ¼å¼**ï¼šQImage (Format_Grayscale8) / QPixmap
- **æ•°æ®å¤„ç†**ï¼šNumPyæ•°ç»„å¤„ç†
- **æ¸²æŸ“ä¼˜åŒ–**ï¼šæŠ—é”¯é½¿ã€ç¡¬ä»¶åŠ é€Ÿ

### ä¼˜åŠ¿

- âœ… **æ˜¾ç¤ºè´¨é‡é«˜**ï¼šæŠ—é”¯é½¿ã€è‡ªé€‚åº”ç¼©æ”¾
- âœ… **æ€§èƒ½ä¼˜ç§€**ï¼šé›¶æ‹·è´ã€QPixmapç¼“å­˜
- âœ… **äº¤äº’å‹å¥½**ï¼šç¼©æ”¾ã€å¹³ç§»ã€å…¨å±
- âœ… **ä»£ç ç®€æ´**ï¼šQtæ¡†æ¶å°è£…å®Œå–„

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
**æœ€åæ›´æ–°**: 2024å¹´

