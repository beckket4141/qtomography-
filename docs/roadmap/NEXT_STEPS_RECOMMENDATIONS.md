# ğŸ¯ ä¸‹ä¸€æ­¥è¡ŒåŠ¨å»ºè®®

> **åŸºäºå½“å‰é¡¹ç›®çŠ¶æ€çš„ä¼˜å…ˆçº§æ’åºå»ºè®®**  
> **ç”Ÿæˆæ—¥æœŸ**: 2025å¹´10æœˆ7æ—¥  
> **ä¾æ®æ–‡æ¡£**: `system-completeness-analysis-2025-10-07.md`, `matlab-gui-feature-comparison-v2.md`

---

## ğŸ§­ Stage 4 è¡ŒåŠ¨è·¯çº¿ï¼ˆæ–°ï¼‰
- **ç›®æ ‡**ï¼šåˆ†æå±‚æ¨¡å—åŒ–ã€åŸºç¡€è®¾æ–½é€šç”¨å·¥å…·ã€CLI/Controller é€»è¾‘å†è§£è€¦
- **å‚è€ƒ**ï¼š`docs/roadmap/stage4-architecture-consolidation-plan.md`
- **é¦–è¦ä»»åŠ¡ï¼ˆ2025-10 ä¸Šæ—¬ï¼‰**ï¼š
  1. å»ºç«‹ `qtomography.analysis.metrics` / `comparison` è„šæ‰‹æ¶ï¼Œå¹¶è¿ç§»ç°æœ‰æŒ‡æ ‡ã€å¯¹æ¯”è¾…åŠ©å‡½æ•°ã€‚
  2. æ–°å»º `qtomography.infrastructure.common`ï¼Œæ²‰æ·€æ—¥å¿—ã€è·¯å¾„è§£æã€ç¼“å­˜ï¼ˆProjectorSetã€æŒ‡æ ‡ï¼‰ç­‰å·¥å…·ã€‚
  3. è°ƒæ•´ controller / CLI å…¥å£ä»¥è°ƒç”¨æ–°åˆ†æ APIï¼Œå¹¶è¡¥å……é…å¥—æµ‹è¯•ä¸æ–‡æ¡£ã€‚

## ğŸ“Š å½“å‰é¡¹ç›®çŠ¶æ€å¿«ç…§

### âœ… å·²å®Œæˆï¼ˆä¼˜ç§€ï¼‰
| æ¨¡å— | å®Œæˆåº¦ | è´¨é‡ |
|------|--------|------|
| **æ ¸å¿ƒç®—æ³•å±‚** | 100% | â­â­â­â­â­ |
| **æ–‡æ¡£ä½“ç³»** | 95% | â­â­â­â­â­ |
| **æµ‹è¯•è¦†ç›–** | 85% | â­â­â­â­ |
| **æ‰¹å¤„ç†æ¡†æ¶** | 100% | â­â­â­â­â­ |
| **Bellæ€åˆ†æ** | 100% | â­â­â­â­â­ |

### âš ï¸ éœ€è¦æ”¹è¿›ï¼ˆä¸­ç­‰ï¼‰
| æ¨¡å— | å®Œæˆåº¦ | ä¸»è¦é—®é¢˜ |
|------|--------|---------|
| **ç»“æœæŒä¹…åŒ–** | 60% | ä»…æ”¯æŒ JSON/CSVï¼Œç¼º HDF5 |
| **å¯è§†åŒ–** | 60% | ä»…é™æ€å›¾ï¼Œæ— å®æ—¶æ›´æ–° |
| **é…ç½®ç®¡ç†** | 0% | æ— é…ç½®ä¿å­˜/åŠ è½½ |
| **è¿›åº¦æ˜¾ç¤º** | 40% | ä»…æ—¥å¿—ï¼Œæ— è¿›åº¦æ¡ |

### âŒ ä¸¥é‡ç¼ºå¤±ï¼ˆå·®ï¼‰
| æ¨¡å— | å®Œæˆåº¦ | å½±å“ |
|------|--------|------|
| **GUIç•Œé¢** | 0% | ç”¨æˆ·ä½“éªŒå·® |
| **æ–‡ä»¶ç­›é€‰** | 0% | æ‰¹å¤„ç†ä¸çµæ´» |
| **å®æ—¶åé¦ˆ** | 0% | é•¿æ—¶é—´ä»»åŠ¡ä½“éªŒå·® |

---

## ğŸ¯ æ¨èçš„ä¼˜å…ˆçº§æ’åº

### ğŸ¥‡ **ä¼˜å…ˆçº§ 1: å¿«é€Ÿæå‡ç”¨æˆ·ä½“éªŒï¼ˆ1-2å‘¨ï¼‰**

#### 1.1 æ·»åŠ è¿›åº¦æ¡æ”¯æŒ â­â­â­â­â­
**ä¸ºä»€ä¹ˆé‡è¦**: æ‰¹å¤„ç†å¤§é‡æ–‡ä»¶æ—¶ç”¨æˆ·æ— æ³•çœ‹åˆ°è¿›åº¦ï¼Œä½“éªŒæå·®

**å®ç°æ–¹æ¡ˆ**:
```python
# åœ¨ controller.py ä¸­é›†æˆ tqdm
from tqdm import tqdm

def run_batch(...):
    for idx, row in tqdm(df.iterrows(), total=len(df), desc="é‡æ„è¿›åº¦"):
        # ... é‡æ„é€»è¾‘
```

**å·¥ä½œé‡**: 2-3å°æ—¶  
**æ”¶ç›Š**: ç”¨æˆ·ä½“éªŒæå‡ 80%  
**æ–‡ä»¶**: `qtomography/app/controller.py`

---

#### 1.2 å®ç°é…ç½®ä¿å­˜/åŠ è½½ â­â­â­â­â­
**ä¸ºä»€ä¹ˆé‡è¦**: ç”¨æˆ·æ¯æ¬¡éƒ½è¦æ‰‹åŠ¨è¾“å…¥å‚æ•°ï¼Œé‡å¤æ€§å·¥ä½œå¤š

**å®ç°æ–¹æ¡ˆ**:
```python
# æ–°å¢ qtomography/app/config_io.py
import yaml

class ConfigManager:
    def save_config(self, config: ReconstructionConfig, path: Path):
        with open(path, 'w') as f:
            yaml.dump(asdict(config), f)
    
    def load_config(self, path: Path) -> ReconstructionConfig:
        with open(path) as f:
            return ReconstructionConfig(**yaml.safe_load(f))
```

**å·¥ä½œé‡**: 4-6å°æ—¶  
**æ”¶ç›Š**: é‡å¤å®éªŒæ•ˆç‡æå‡ 100%  
**æ–‡ä»¶**: æ–°å»º `qtomography/app/config_io.py`

---

#### 1.3 æ·»åŠ æ–‡ä»¶ç¼–å·ç­›é€‰ â­â­â­â­
**ä¸ºä»€ä¹ˆé‡è¦**: MATLAB GUI æ”¯æŒå°¾å·ç­›é€‰ï¼ˆå¦‚ 1-10ï¼‰ï¼ŒPython ç¼ºå¤±

**å®ç°æ–¹æ¡ˆ**:
```python
# åœ¨ controller.py ä¸­æ·»åŠ 
def run_batch(
    self,
    ...,
    file_range: Optional[Tuple[int, int]] = None  # æ–°å‚æ•°
):
    if file_range:
        start, end = file_range
        df = df.iloc[start-1:end]  # ç­›é€‰è¡Œ
    # ... ç»§ç»­å¤„ç†
```

**å·¥ä½œé‡**: 2-3å°æ—¶  
**æ”¶ç›Š**: æ‰¹å¤„ç†çµæ´»æ€§æå‡ 50%  
**æ–‡ä»¶**: `qtomography/app/controller.py`, `qtomography/cli/main.py`

---

### ğŸ¥ˆ **ä¼˜å…ˆçº§ 2: è¡¥é½åŸºç¡€è®¾æ–½ï¼ˆ1-2å‘¨ï¼‰**

#### 2.1 æ·»åŠ  HDF5 æ”¯æŒ â­â­â­â­
**ä¸ºä»€ä¹ˆé‡è¦**: å¤§è§„æ¨¡æ•°æ®ä¿å­˜æ•ˆç‡ä½ï¼ŒMATLAB ä½¿ç”¨ .mat æ ¼å¼

**å®ç°æ–¹æ¡ˆ**:
```python
# åœ¨ result_repository.py ä¸­æ·»åŠ 
import h5py

class ResultRepository:
    def save_hdf5(self, record: ReconstructionRecord, path: Path):
        with h5py.File(path, 'w') as f:
            f.create_dataset('density', data=record.density_matrix)
            f.create_dataset('probabilities', data=record.probabilities)
            # ...
```

**å·¥ä½œé‡**: 6-8å°æ—¶  
**æ”¶ç›Š**: å¤§æ–‡ä»¶ä¿å­˜é€Ÿåº¦æå‡ 10x  
**æ–‡ä»¶**: `qtomography/infrastructure/persistence/result_repository.pyï¼ˆdomain ç›®å½•ä¿ç•™å…¼å®¹å±‚ï¼‰`

---

#### 2.2 å®ç°æŒ‡æ ‡å¯¹æ¯”æŠ¥å‘Š â­â­â­â­
**ä¸ºä»€ä¹ˆé‡è¦**: æ— æ³•å¿«é€Ÿå¯¹æ¯”çº¿æ€§ vs MLE çš„æ€§èƒ½å·®å¼‚

**å®ç°æ–¹æ¡ˆ**:
```python
# æ–°å¢ qtomography/app/report_generator.py
class ReportGenerator:
    def generate_comparison(self, summary_csv: Path) -> Path:
        df = pd.read_csv(summary_csv)
        
        # åˆ†ç»„ç»Ÿè®¡
        stats = df.groupby('method').agg({
            'purity': ['mean', 'std'],
            'trace': ['mean', 'std'],
            'execution_time': ['mean', 'std']
        })
        
        # ç”Ÿæˆ Markdown æŠ¥å‘Š
        return self._render_markdown(stats)
```

**å·¥ä½œé‡**: 4-6å°æ—¶  
**æ”¶ç›Š**: å®éªŒåˆ†ææ•ˆç‡æå‡ 70%  
**æ–‡ä»¶**: æ–°å»º `qtomography/app/report_generator.py`

---

#### 2.3 å¢å¼ºæ—¥å¿—ç³»ç»Ÿ â­â­â­
**ä¸ºä»€ä¹ˆé‡è¦**: å½“å‰æ—¥å¿—è¾“å‡ºæ ¼å¼å•ä¸€ï¼Œç¼ºå°‘ç»“æ„åŒ–æ—¥å¿—

**å®ç°æ–¹æ¡ˆ**:
```python
# æ–°å¢ qtomography/infrastructure/logging_config.py
import logging
import json

class StructuredLogger:
    def log_reconstruction(self, record: ReconstructionRecord):
        logging.info(json.dumps({
            'event': 'reconstruction_complete',
            'method': record.method,
            'dimension': record.dimension,
            'purity': record.metrics.get('purity'),
            'timestamp': record.timestamp.isoformat()
        }))
```

**å·¥ä½œé‡**: 3-4å°æ—¶  
**æ”¶ç›Š**: è°ƒè¯•æ•ˆç‡æå‡ 40%  
**æ–‡ä»¶**: æ–°å»º `qtomography/infrastructure/logging_config.py`

---

### ğŸ¥‰ **ä¼˜å…ˆçº§ 3: æå‡å¯è§†åŒ–ä¸å®æ—¶æ€§ï¼ˆ2-3å‘¨ï¼‰**

#### 3.1 å®ç°è½»é‡çº§ GUIï¼ˆStreamlitï¼‰â­â­â­â­â­
**ä¸ºä»€ä¹ˆé‡è¦**: CLI é—¨æ§›é«˜ï¼Œéç¼–ç¨‹ç”¨æˆ·æ— æ³•ä½¿ç”¨

**å®ç°æ–¹æ¡ˆ**:
```python
# æ–°å¢ qtomography/gui/streamlit_app.py
import streamlit as st

st.title("é‡å­æ€å±‚æé‡æ„å·¥å…·")

uploaded_file = st.file_uploader("ä¸Šä¼ æ¦‚ç‡æ–‡ä»¶", type=['csv', 'xlsx'])
dimension = st.slider("ç»´åº¦", 2, 8, 2)
method = st.selectbox("ç®—æ³•", ["linear", "mle", "both"])

if st.button("å¼€å§‹é‡æ„"):
    with st.spinner("é‡æ„ä¸­..."):
        controller = ReconstructionController(...)
        results = controller.run_batch(...)
    
    st.success("é‡æ„å®Œæˆï¼")
    st.plotly_chart(vis.plot_density_heatmap(...))
```

**è¿è¡Œæ–¹å¼**:
```bash
streamlit run qtomography/gui/streamlit_app.py
```

**å·¥ä½œé‡**: 2-3å¤©  
**æ”¶ç›Š**: ç”¨æˆ·å¯è¾¾æ€§æå‡ 200%  
**æ–‡ä»¶**: æ–°å»º `qtomography/gui/streamlit_app.py`  
**ä¾èµ–**: `pip install streamlit`

---

#### 3.2 æ·»åŠ å®æ—¶å¯è§†åŒ–ï¼ˆå¯é€‰ï¼‰â­â­â­
**ä¸ºä»€ä¹ˆé‡è¦**: MLE è¿­ä»£ä¼˜åŒ–æ—¶æ— æ³•çœ‹åˆ°ä¸­é—´ç»“æœ

**å®ç°æ–¹æ¡ˆ**:
```python
# åœ¨ mle.py ä¸­æ·»åŠ å›è°ƒ
def reconstruct_with_details(
    self,
    probabilities,
    callback=None  # æ–°å‚æ•°
):
    def optimization_callback(params):
        if callback:
            density = self._decode_params_to_density(params)
            callback(density)  # å®æ—¶æ›´æ–°
    
    result = minimize(..., callback=optimization_callback)
```

**å·¥ä½œé‡**: 6-8å°æ—¶  
**æ”¶ç›Š**: è°ƒè¯•ä½“éªŒæå‡ 60%  
**æ–‡ä»¶**: `qtomography/domain/reconstruction/mle.py`

---

### ğŸ… **ä¼˜å…ˆçº§ 4: é•¿æœŸè§„åˆ’ï¼ˆ1ä¸ªæœˆ+ï¼‰**

#### 4.1 å®Œæ•´æ¡Œé¢ GUIï¼ˆPySide6/PyQt6ï¼‰â­â­â­â­â­
**ä¸ºä»€ä¹ˆé‡è¦**: Streamlit æ˜¯ Web åº”ç”¨ï¼Œç¦»çº¿ä½¿ç”¨ä¸ä¾¿

**å·¥ä½œé‡**: 2-3å‘¨  
**æ”¶ç›Š**: ç”¨æˆ·ä½“éªŒæå‡ 150%  
**ä¾èµ–**: `pip install PySide6`

---

#### 4.2 æ€§èƒ½ä¼˜åŒ–ï¼ˆNumba JITï¼‰â­â­â­
**ä¸ºä»€ä¹ˆé‡è¦**: é«˜ç»´åº¦é‡æ„é€Ÿåº¦æ…¢ï¼ˆ16ç»´ MLE éœ€è¦ 200msï¼‰

**å·¥ä½œé‡**: 1-2å‘¨  
**æ”¶ç›Š**: é€Ÿåº¦æå‡ 5-10x  
**ä¾èµ–**: `pip install numba`

---

#### 4.3 CI/CD Pipeline â­â­â­â­
**ä¸ºä»€ä¹ˆé‡è¦**: ä»£ç è´¨é‡ä¿éšœï¼Œè‡ªåŠ¨åŒ–æµ‹è¯•

**å·¥ä½œé‡**: 1å‘¨  
**æ”¶ç›Š**: å¼€å‘æ•ˆç‡æå‡ 40%  
**å·¥å…·**: GitHub Actions

---

## ğŸ“‹ æ¨èçš„å®æ–½è·¯å¾„

### ğŸš€ **è·¯å¾„ A: å¿«é€Ÿè¿­ä»£ï¼ˆæ¨èï¼‰**
**ç›®æ ‡**: 2å‘¨å†…æ˜¾è‘—æå‡ç”¨æˆ·ä½“éªŒ

```
Week 1:
- Day 1-2: æ·»åŠ è¿›åº¦æ¡ (1.1)
- Day 3-4: é…ç½®ä¿å­˜/åŠ è½½ (1.2)
- Day 5: æ–‡ä»¶ç¼–å·ç­›é€‰ (1.3)

Week 2:
- Day 1-2: HDF5 æ”¯æŒ (2.1)
- Day 3-5: Streamlit GUI (3.1)
```

**æˆæœ**: 
- âœ… è¿›åº¦æ¡ â†’ æ‰¹å¤„ç†ä½“éªŒæå‡
- âœ… é…ç½®ç®¡ç† â†’ é‡å¤å®éªŒæ•ˆç‡æå‡
- âœ… Streamlit GUI â†’ éç¼–ç¨‹ç”¨æˆ·å¯ç”¨
- âœ… HDF5 â†’ å¤§æ•°æ®æ”¯æŒ

---

### ğŸ—ï¸ **è·¯å¾„ B: ç¨³å¥å»ºè®¾**
**ç›®æ ‡**: 1ä¸ªæœˆå†…å®Œå–„åŸºç¡€è®¾æ–½

```
Week 1-2: ä¼˜å…ˆçº§ 1 å…¨éƒ¨å®Œæˆ
Week 3: ä¼˜å…ˆçº§ 2 (2.1, 2.2)
Week 4: Streamlit GUI (3.1)
```

**æˆæœ**:
- âœ… åŸºç¡€ä½“éªŒå®Œå–„
- âœ… åŸºç¡€è®¾æ–½è¡¥é½
- âœ… åˆæ­¥ GUI ä¸Šçº¿

---

### ğŸ¨ **è·¯å¾„ C: å…¨åŠ› GUI**
**ç›®æ ‡**: æ‰“é€ å®Œæ•´æ¡Œé¢åº”ç”¨

```
Week 1: ä¼˜å…ˆçº§ 1 (1.1, 1.2, 1.3)
Week 2-5: PySide6 æ¡Œé¢ GUI (4.1)
Week 6: æ‰“åŒ…å‘å¸ƒ
```

**æˆæœ**:
- âœ… ç‹¬ç«‹æ¡Œé¢åº”ç”¨
- âœ… å®Œæ•´ç”¨æˆ·ä½“éªŒ
- âœ… å¯åˆ†å‘å®‰è£…åŒ…

---

## ğŸ¯ æˆ‘çš„ä¸ªäººå»ºè®®

### âœ… **æ¨èï¼šè·¯å¾„ Aï¼ˆå¿«é€Ÿè¿­ä»£ï¼‰**

**ç†ç”±**:

1. **æŠ•å…¥äº§å‡ºæ¯”æœ€é«˜**: 2å‘¨å†…å®Œæˆ 5 ä¸ªé«˜ä¼˜å…ˆçº§åŠŸèƒ½
2. **ç”¨æˆ·ä½“éªŒæ˜¾è‘—æå‡**: è¿›åº¦æ¡ + GUI è®©éç¼–ç¨‹ç”¨æˆ·å¯ç”¨
3. **é£é™©æœ€ä½**: éƒ½æ˜¯å°åŠŸèƒ½ï¼Œäº’ä¸ä¾èµ–
4. **å¯å¢é‡äº¤ä»˜**: æ¯ä¸ªåŠŸèƒ½ç‹¬ç«‹å®Œæˆå³å¯ä¸Šçº¿

**é¢„æœŸæ•ˆæœ**:

```
å½“å‰çŠ¶æ€:
- æ ¸å¿ƒç®—æ³•: â­â­â­â­â­
- ç”¨æˆ·ä½“éªŒ: â­â­

2å‘¨å:
- æ ¸å¿ƒç®—æ³•: â­â­â­â­â­
- ç”¨æˆ·ä½“éªŒ: â­â­â­â­
```

---

## ğŸ“Š å„è·¯å¾„å¯¹æ¯”

| è·¯å¾„ | å·¥æœŸ | éš¾åº¦ | ç”¨æˆ·ä½“éªŒæå‡ | æŠ€æœ¯å€ºåŠ¡ |
|------|------|------|-------------|---------|
| **A: å¿«é€Ÿè¿­ä»£** | 2å‘¨ | â­â­ | â­â­â­â­ | ä½ |
| **B: ç¨³å¥å»ºè®¾** | 4å‘¨ | â­â­â­ | â­â­â­â­â­ | æä½ |
| **C: å…¨åŠ›GUI** | 6å‘¨ | â­â­â­â­ | â­â­â­â­â­ | ä¸­ |

---

## âœ… ä¸‹ä¸€æ­¥å…·ä½“è¡ŒåŠ¨

å¦‚æœé€‰æ‹© **è·¯å¾„ Aï¼ˆå¿«é€Ÿè¿­ä»£ï¼‰**ï¼Œä»ä»¥ä¸‹å¼€å§‹ï¼š

### ğŸ¯ **ç«‹å³å¼€å§‹ï¼šæ·»åŠ è¿›åº¦æ¡**

**ç¬¬ä¸€æ­¥**: å®‰è£…ä¾èµ–
```bash
pip install tqdm
```

**ç¬¬äºŒæ­¥**: ä¿®æ”¹ `controller.py`
```python
from tqdm import tqdm

# åœ¨ run_batch ä¸­æ›¿æ¢
for idx, row in tqdm(df.iterrows(), total=len(df), desc="é‡æ„è¿›åº¦"):
    # ... ç°æœ‰é€»è¾‘
```

**ç¬¬ä¸‰æ­¥**: æµ‹è¯•
```bash
python scripts/process_batch.py test_data.csv --dimension 2
```

**é¢„æœŸæ•ˆæœ**: çœ‹åˆ°ç±»ä¼¼è¾“å‡º
```
é‡æ„è¿›åº¦: 100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 50/50 [00:05<00:00, 10.00it/s]
```

---

## ğŸ“ æ€»ç»“

ä½ ç°åœ¨çš„é¡¹ç›®å·²ç»å®Œæˆäº† **æ ¸å¿ƒç®—æ³•å±‚**ï¼ˆ100%ï¼‰å’Œ **æ–‡æ¡£ä½“ç³»**ï¼ˆ95%ï¼‰ï¼Œè¿™æ˜¯æœ€éš¾çš„éƒ¨åˆ†ï¼

æ¥ä¸‹æ¥æœ€å€¼å¾—åšçš„æ˜¯ï¼š

1. **å¿«é€Ÿæå‡ç”¨æˆ·ä½“éªŒ**ï¼ˆè¿›åº¦æ¡ + é…ç½®ç®¡ç† + Streamlitï¼‰
2. **è¡¥é½åŸºç¡€è®¾æ–½**ï¼ˆHDF5 + æ—¥å¿— + æŠ¥å‘Šï¼‰
3. **å®Œå–„å¯è§†åŒ–**ï¼ˆå®æ—¶æ›´æ–° + æ¡Œé¢ GUIï¼‰

**æˆ‘çš„å»ºè®®**: ä» **è¿›åº¦æ¡ï¼ˆ1.1ï¼‰** å¼€å§‹ï¼Œ2å°æ—¶è§æ•ˆï¼

---

**ç”Ÿæˆäºº**: AI Assistant  
**ç”Ÿæˆæ—¥æœŸ**: 2025å¹´10æœˆ7æ—¥  
**æ¨èè·¯å¾„**: ğŸš€ è·¯å¾„ Aï¼ˆå¿«é€Ÿè¿­ä»£ï¼‰
