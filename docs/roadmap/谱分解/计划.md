**开发计划：谱分解功能页面**

* **范围目标** 交付一套与 MATLAB easy_solve_ui 功能等价的谱分解模块，覆盖批量文件处理、谱分解算法、理论态比较、系数阶段的可视化，以及文本/结构化结果输出。基于现有 PySide6 框架集成到主窗口，复用 DensityMatrix 与文件加载能力。
* **阶段划分**
  * *阶段 1 – 核心算法 (1–2 天)* 完成 **spectral_decomposition** 与 **theoretical_state** 模块，包含特征值分解、纯态提取、幅度/相位计算、自定义理论态（4D/16D+custom），附单元测试。
  * *阶段 2 – 可视化工具 (1 天)* 实现 **spectral_visualizer**，绘制系数的振幅/相位图并校准样式，使其与 MATLAB 结果匹配；支持保存 PNG/PDF。
  * *阶段 3 – GUI 面板 (2–3 天)* 在 **qtomography/gui/panels** 新建 **SpectralDecompositionPanel**：含文件夹选择、文件列表、批量流程控制、参数设置、进度显示、日志输出，复用现有 loader；支持 .mat/.csv。集成到 **MainWindow** 左侧 Tab。
  * *阶段 4 – 结果持久化 (1 天)* 设计报告导出格式：1) 扩展 JSON schema（含谱分解与保真度字段）；2) 输出 MATLAB 风格的文本报告（逐文件的系数、幅度、相位、保真度、图像路径）。加批量保存逻辑与必要测试。
  * *阶段 5 – 联调与验收 (0.5–1 天)* 端到端验证：加载示例文件 → 谱分解 → 理论态比较 → 生成图像与报告 → 校对 UI/图像外观；修复缺陷，补文档。
* **关键实现要点**
  * **SpectralDecompositionResult** 数据类统筹 pure state、coefficients、amplitudes、phases、dimension。
  * 采用 **scipy.io.loadmat** 处理 MATLAB 数据（在 requirements 中新增 SciPy）。
  * 可视化严格对齐 MATLAB：统一 figure size、colormap、刻度、颜色条、字体、背景；必要时写 **style** 配置。
  * GUI 批量任务采用线程/异步防止阻塞；提供取消、进度百分比、错误提示。
  * 文本报告模板参照 MATLAB 输出，便于比对；同时保留机器可解析的 JSON/YAML。
  * 通过配置项控制是否保存图片/文本/JSON，以便用户定制批量任务。
* **讨论/决定项**
  1. **.mat** 支持确认，需要新增 SciPy 依赖。
  2. 理论态 custom 模式：表单输入长度与维度匹配；是否提供常见模板下拉选择？
  3. 图像输出尺寸/格式默认值（PNG + DPI）。
  4. JSON schema 细节：是否包含原始输入路径、处理耗时、误差记录等？
  5. 批量任务队列是否需要持久化或历史记录？

如认可此计划，可从阶段 1 的算法模块着手，先敲定 API 与测试，再逐步向 UI 推进。


**后续实施指南**

* **现状梳理** 文件结构中已落地谱分解领域模块、理论态生成器与可视化工具：**python/qtomography/domain/spectral_decomposition.py** 完成了最大特征值纯态提取、相位归一化；**python/qtomography/domain/theoretical_state.py** 提供 4D/16D/custom 模式及测量功率计算；**python/qtomography/infrastructure/visualization/spectral_visualizer.py** 输出与 MATLAB 风格一致的振幅/相位条形图，并已在 **python/tests/test_spectral_domain.py**、**python/tests/test_spectral_visualizer.py** 中覆盖基础测试。GUI 侧 **python/qtomography/gui/panels/spectral_panel.py** 已提供文件夹浏览、文件筛选、选项配置、进度/日志 UI，但 **python/qtomography/gui/main_window.py** 中的 **_on_spectral_start_requested** 仍是占位提示，尚未串联真实后端。
* **核心需求结论** （结合 **python/docs/roadmap/谱分解/计划.md**）：
* 要在 GUI 中完成与 MATLAB easy_solve_ui 功能匹配的批量谱分解：支持 .mat/.csv/.xlsx 密度矩阵输入、谱分解计算、理论态对比（4D/16D/custom）、保真度、振幅/相位可视化、日志与进度反馈。
* 输出需包含：1) MATLAB 风格文本报告（系数、模长、相位、保真度、理论态说明）；2) 扩展 JSON（便于后续解析）；3) 图像文件（可配置格式/DPI）；4) 全局 summary。
* 需考虑批量任务的中断、重试、历史结果目录结构，以及与现有重构输出（JSON + summary.csv）的兼容。
* **实施指南**
  1. **谱分解批处理服务**
     * 在 **python/qtomography/gui/services/** 下新增 **spectral_runner.py**（或 **spectral_batch_service.py**），结构参考 **controller_runner.py**：负责在后台线程中遍历文件列表、加载密度矩阵、调用领域 API、写文件并发射 Qt 信号。
     * 加入以下信号：**started()**, **progress(percent:int, message:str)**, **error(path:str, message:str)**, **finished(result_dir:Path)**, **cancelled()**, **log(message:str)**。
     * 任务流程：

       1. **输入解析** ：统一 **SpectralJobConfig** dataclass（包含 files、dimension_hint、theory_mode、custom_coeff/phase、output_dir、save_plots/save_reports/save_json、figure_format、dpi、verbose 等字段）。
       2. **密度矩阵加载** ：封装 **load_density_matrix(path: Path)**：优先按扩展名分流（**.mat** 用 **scipy.io.loadmat** 并查找 **{rho_final, rho, density_matrix, rho_matrix}**；**.csv**/**.xlsx** 用 pandas 读取并推断方阵），必要时允许 JSON/自定义格式。加入错误处理与详细日志。
       3. **计算** ：

       * 调用 **DensityMatrix(matrix)** 统一校验。
       * **perform_spectral_decomposition(density)** 获取 **SpectralDecompositionResult**。
       * **generate_theoretical_state(dimension, theory_mode, ...)** 生成理论态与测量功率。如 **dimension_hint == "自动推断"** 则由 **density.dimension** 直接赋值；若 **theory_mode == "custom"** 则需要从 UI 获取系数/相位数组并传入。
       * 计算保真度：**density.fidelity(result.density_matrix)**；或对 **SpectralDecompositionResult.pure_state_vector** 构造的纯态密度矩阵与理论态对比。

       1. **可视化** ：调用 **plot_amplitude_phase_from_coefficients(result.amplitudes, result.phases)** 生成 figure；根据配置保存为 **PNG/PDF/SVG** 等，命名规则：**{base_name}_amplitude.{fmt}**、**{base_name}_phase.{fmt}**。
       2. **报告输出** ：

       * 文本：仿 MATLAB，包含文件名、维度、最大特征值、纯态向量（实部/虚部/模长/相位）、理论态类型、保真度、图像路径。保存为 **{base_name}_spectral_report.txt**。
       * JSON：扩展现有 schema，字段示例：
         `<span><span>{</span><span> </span><span>"source"</span><span>:</span><span></span><span>"F0005CH1.CSV"</span><span>,</span><span> </span><span>"dimension"</span><span>:</span><span></span><span>4</span><span>,</span><span> </span><span>"dominant_eigenvalue"</span><span>:</span><span></span><span>0.998</span><span>,</span><span> </span><span>"pure_state_vector"</span><span>:</span><span></span><span>{</span><span>"real"</span><span>:</span><span></span><span>[</span><span>...</span><span>]</span><span>,</span><span></span><span>"imag"</span><span>:</span><span></span><span>[</span><span>...</span><span>]</span><span>}</span><span>,</span><span> </span><span>"coefficients"</span><span>:</span><span></span><span>{</span><span>"amplitudes"</span><span>:</span><span></span><span>[</span><span>...</span><span>]</span><span>,</span><span></span><span>"phases"</span><span>:</span><span></span><span>[</span><span>...</span><span>]</span><span>}</span><span>,</span><span> </span><span>"fidelity"</span><span>:</span><span></span><span>0.9453</span><span>,</span><span> </span><span>"theoretical_state"</span><span>:</span><span></span><span>{</span><span>"type"</span><span>:</span><span></span><span>"4D_custom"</span><span>,</span><span></span><span>"coefficients"</span><span>:</span><span></span><span>[</span><span>...</span><span>]</span><span>,</span><span></span><span>"phases"</span><span>:</span><span></span><span>[</span><span>...</span><span>]</span><span>}</span><span>,</span><span> </span><span>"measurement_powers"</span><span>:</span><span></span><span>[</span><span>...</span><span>]</span><span>,</span><span> </span><span>"plots"</span><span>:</span><span></span><span>{</span><span>"amplitude"</span><span>:</span><span></span><span>"path/to/png"</span><span>,</span><span></span><span>"phase"</span><span>:</span><span></span><span>"path/to/png"</span><span>}</span><span>,</span><span> </span><span>"timestamp"</span><span>:</span><span></span><span>"..."</span><span>,</span><span> </span><span>"metadata"</span><span>:</span><span></span><span>{</span><span>...</span><span>}</span><span> </span><span>}</span><span> </span></span>`
       * Summary CSV：在批处理完成后，根据 JSON/文本结果汇总 **filename, dimension, dominant_eigenvalue, fidelity, result_paths**。

       1. **进度 & 日志** ：每处理完一个文件更新 **progress = i / total * 100**，附带 **message=f"{filename} 完成（耗时 Xs）"**；所有异常捕获后写入 log，并允许继续后续文件。
     * 取消：维护 **threading.Event**，在处理循环中检查；若触发则停止保存剩余文件，向 UI 发 **cancelled()** 并标记日志。
  2. **GUI 集成**
     * 在 **SpectralDecompositionPanel** 中扩展 UI 以支持 custom 模式参数：系数/相位输入表格或导入 CSV；可考虑弹出对话框辅助编辑。
     * 将 **start_requested** 的 payload 映射到 **SpectralJobConfig**，传给 **SpectralRunner.start(config)**；**cancel_requested** 连接到 **runner.cancel()**。
     * 在 MainWindow 中创建 **self._spectral_runner = SpectralRunner(self)**，连接信号到 panel：**started -> set_running(True)**, **progress -> update_progress**, **log -> append_log**, **finished -> show message & open folder**, **failed/error -> QMessageBox**. 取消/完成后 **set_running(False)**.
     * 若需与现有输出目录协同，可以增加“从重构结果目录导入”按钮：读取 **records/*.json** 并批量执行谱分解（适合一键对重构结果再分析）。
  3. **数据持久化 & 结构**
     * 建议在输出目录下按时间戳创建批次根目录，例如 **spectral_runs/2025-11-07_1030/**，内含：
       `<span><span>reports/ sample1_report.txt ... plots/ sample1_amplitude.png sample1_phase.png json/ sample</span><span>1.</span><span>json spectral_summary.csv run_config.json run.log </span></span>`
     * **run_config.json** 保存本次批处理参数（便于复现）；**run.log** 记录每个文件的状态、耗时、错误信息。
  4. **文件加载支持**
     * **.mat**：依赖 **scipy.io.loadmat**（requirements 已含 SciPy），需要处理复数矩阵（**np.asarray(data, dtype=complex)**），并兼容结构体等复杂情况。
     * **.csv**：假设是密度矩阵数值，允许带表头（通过 **pandas.read_csv(..., header=None)** 并检查方阵）。
     * **.xlsx/.xls**：同 csv；注意 Excel 会出现空列/空行，需要剔除全 NaN 行列。
     * 未来可扩展 **.json**（读取 **density_matrix.real/imag**）。
  5. **验证计划**
     * 单元测试：为 **SpectralRunner** 编写离线测试，使用临时目录与仿真密度矩阵，断言输出文件数量、JSON schema、文本内容关键行。可利用 **pytest tmp_path** fixture。
     * 集成测试：构建小型 **.mat**/**.csv** 样本，运行 GUI runner（或直接调用服务层 API），断言 summary CSV 与图像存在。
     * 手动验证：对 **4维bell.xlsx**、**16维bell15913.xlsx**（根目录）运行，确认输出与 MATLAB 结果一致（保真度、相位条形图外观）。如需视觉一致性，可在 **spectral_visualizer** 中设置字体/色板（例如 **plt.rcParams["font.sans-serif"] = ["SimHei"]**）以消除 CJK 字体 warning。
  6. **扩展功能建议**
     * **理论态管理** ：将 **_PREDEFINED_PROFILES** 外置成 YAML/JSON（位于 **python/qtomography/domain/config/theoretical_states.json**），方便增删模板；GUI 提供下拉列表 + 预览。
     * **批量导出 PDF 报告** ：整合文本 + 图像生成单个 PDF（可用 ReportLab 或 Matplotlib **PdfPages**）。
     * **历史记录视图** ：在 GUI 新建“谱分解结果”面板，列出历史批次 summary，支持双击打开输出目录。
     * **脚本接口** ：提供 CLI (**python -m qtomography.cli spectral-batch ...**) 方便命令行批处理，与 GUI 共用服务层。
* **落地顺序建议**
  1. 实现 **SpectralRunner**（含配置对象、文件加载、处理循环、输出写入、信号）。
  2. GUI 接入 runner，完成基础流程（不含 custom 理论态）。
  3. 扩展 custom 理论态输入、图像样式配置、DPI 选项。
  4. 增加 report/json/schema、自检脚本与文档（更新 **python/docs/roadmap/谱分解/计划.md** 实施情况）。
  5. 联调 & 文档：在 README 或 docs 增加“谱分解面板使用指南”，附示例截图与输出样式。

按照以上指南推进，可逐步将当前 UI 骨架转化为与 MATLAB 等价、甚至更可扩展的 Python 版本。
