# 谱分解功能计划检查报告

## 📋 计划合理性分析

### ✅ 计划整体结构合理

**优点：**
1. **阶段划分清晰**：从核心算法 → 可视化 → GUI → 持久化 → 联调，符合软件开发流程
2. **时间估算合理**：总计约 5-7 天，对于该功能规模是合理的
3. **技术选型正确**：
   - 使用 `scipy.io.loadmat` 处理 MATLAB 文件
   - 复用现有 `DensityMatrix` 和 `ProjectorSet`
   - 采用 Qt 信号/槽机制实现异步批处理
4. **实施指南详细**：提供了具体的代码结构、数据流、文件格式等细节

### ⚠️ 需要调整的地方

1. **文件加载逻辑**：
   - 计划中提到需要实现 `load_density_matrix`，但项目中已有 `_load_probabilities`（用于加载测量数据）
   - 建议：复用现有文件加载基础设施，但需要区分**密度矩阵**和**测量概率**两种输入类型

2. **Custom 理论态输入**：
   - 计划中提到"表单输入或导入 CSV"，但 GUI 面板中尚未实现
   - 建议：先实现基础流程，再扩展 custom 模式

3. **输出目录结构**：
   - 计划建议使用时间戳目录，但需要考虑与现有重构输出目录的兼容性
   - 建议：统一输出目录结构规范

---

## 📊 当前进展评估

### ✅ 已完成（约 60%）

#### 阶段 1 - 核心算法 ✅ **100% 完成**
- ✅ `spectral_decomposition.py`：完整实现
  - `SpectralDecompositionResult` 数据类
  - `perform_spectral_decomposition()` 函数
  - 特征值分解、纯态提取、相位归一化
- ✅ `theoretical_state.py`：完整实现
  - `TheoreticalStateResult` 数据类
  - `generate_theoretical_state()` 函数
  - 支持 4D_custom、16D_custom、custom 模式
  - 测量功率计算、保真度计算
- ✅ 单元测试：`test_spectral_domain.py` 覆盖核心功能

#### 阶段 2 - 可视化工具 ✅ **100% 完成**
- ✅ `spectral_visualizer.py`：完整实现
  - `plot_amplitude_phase_from_coefficients()` 函数
  - MATLAB 风格的振幅/相位条形图
  - 支持相位包装、自定义标题
- ✅ 单元测试：`test_spectral_visualizer.py` 验证可视化功能

#### 阶段 3 - GUI 面板 ⚠️ **50% 完成**
- ✅ `spectral_panel.py`：UI 完整实现
  - 文件夹浏览、文件列表、文件筛选
  - 选项配置（维度、理论态、图像格式）
  - 进度条、日志视图
  - 开始/停止按钮
- ✅ `main_window.py`：面板已集成到主窗口
  - 左侧 Tab 中已添加"谱分解"标签页
- ❌ **缺失**：后端服务连接
  - `_on_spectral_start_requested()` 仍是占位符
  - 未实现 `SpectralRunner` 服务

### ❌ 未完成（约 40%）

#### 阶段 3 - GUI 集成（剩余部分）
- ❌ `SpectralRunner` 服务类（`python/qtomography/gui/services/spectral_runner.py`）
  - 需要参考 `controller_runner.py` 的结构
  - 实现 Qt 信号：`started`, `progress`, `finished`, `failed`, `cancelled`, `log`
  - 实现后台线程执行批处理
- ❌ 文件加载模块
  - `.mat` 文件：需要实现 `load_density_matrix_from_mat()`
  - `.csv`/`.xlsx` 文件：需要实现 `load_density_matrix_from_csv()` / `load_density_matrix_from_excel()`
  - 注意：需要区分**密度矩阵输入**和**测量概率输入**（现有 `_load_probabilities` 是后者）

#### 阶段 4 - 结果持久化 ❌ **0% 完成**
- ❌ 文本报告生成
  - MATLAB 风格的 `.txt` 报告
  - 包含：文件名、维度、特征值、纯态向量、理论态、保真度、图像路径
- ❌ JSON 结果输出
  - 扩展现有 JSON schema
  - 包含谱分解相关字段
- ❌ Summary CSV
  - 批量处理结果汇总
  - 字段：filename, dimension, dominant_eigenvalue, fidelity, result_paths
- ❌ 输出目录结构
  - 时间戳批次目录
  - `reports/`, `plots/`, `json/` 子目录
  - `run_config.json`, `run.log`

#### 阶段 5 - 联调与验收 ❌ **0% 完成**
- ❌ 端到端测试
- ❌ 与 MATLAB 结果对比验证
- ❌ 文档更新

---

## 🔍 关键发现

### 1. 代码复用机会

**现有基础设施可复用：**
- ✅ `DensityMatrix` 类：已支持密度矩阵验证和保真度计算
- ✅ `ProjectorSet` 类：已用于理论态测量功率计算
- ✅ `_load_probabilities()`：可作为文件加载的参考（但需要区分输入类型）
- ✅ `ControllerRunner`：可作为 `SpectralRunner` 的参考实现

**需要新建：**
- ❌ `SpectralRunner`：批处理服务
- ❌ `load_density_matrix()`：密度矩阵文件加载（不同于测量概率加载）
- ❌ 报告生成模块

### 2. 技术债务

1. **Custom 理论态输入**：
   - GUI 面板中 `theory_mode_combo` 包含 "custom" 选项
   - 但未提供系数/相位输入界面
   - **建议**：先实现 4D_custom 和 16D_custom，custom 模式后续扩展

2. **文件格式支持**：
   - 计划中提到支持 `.mat`/`.csv`/`.xlsx`
   - 但现有代码中 `.mat` 加载逻辑分散（如 `liner_compare_mat.py`）
   - **建议**：统一封装为 `load_density_matrix()` 函数

3. **输出格式**：
   - 计划中提到多种输出格式（文本/JSON/CSV/图像）
   - 但未明确与现有重构输出的兼容性
   - **建议**：统一输出目录结构规范

### 3. 潜在风险

1. **MATLAB 文件格式多样性**：
   - `.mat` 文件可能包含多个变量
   - 需要智能识别密度矩阵字段（`rho_final`, `rho`, `density_matrix`, `rho_matrix`）
   - **缓解**：参考 `liner_compare_mat.py` 中的实现

2. **Excel 文件复杂性**：
   - 可能包含多个工作表
   - 可能包含表头、空行/空列
   - **缓解**：参考 `_load_probabilities()` 中的处理逻辑

3. **GUI 线程阻塞**：
   - 批处理可能耗时较长
   - **缓解**：使用 `SpectralRunner` 在后台线程执行，通过 Qt 信号更新 UI

---

## 📝 实施建议

### 优先级排序

1. **高优先级（核心功能）**：
   - ✅ 实现 `SpectralRunner` 服务
   - ✅ 实现 `load_density_matrix()` 函数（支持 .mat/.csv/.xlsx）
   - ✅ 连接 GUI 与后端（替换占位符）
   - ✅ 实现基础报告输出（文本 + JSON）

2. **中优先级（增强功能）**：
   - ⚠️ 实现 Summary CSV
   - ⚠️ 完善输出目录结构
   - ⚠️ 扩展 custom 理论态输入界面

3. **低优先级（优化）**：
   - 📋 与 MATLAB 结果对比验证
   - 📋 性能优化
   - 📋 文档完善

### 实施步骤建议

**第一步：实现文件加载**
```python
# python/qtomography/infrastructure/io/density_loader.py
def load_density_matrix(path: Path) -> np.ndarray:
    """统一接口加载密度矩阵"""
    if path.suffix == '.mat':
        return load_density_matrix_from_mat(path)
    elif path.suffix in {'.csv', '.xlsx', '.xls'}:
        return load_density_matrix_from_table(path)
    else:
        raise ValueError(f"Unsupported format: {path.suffix}")
```

**第二步：实现 SpectralRunner**
```python
# python/qtomography/gui/services/spectral_runner.py
class SpectralRunner(QtCore.QObject):
    started = QtCore.Signal()
    progress = QtCore.Signal(int, str)  # percent, message
    finished = QtCore.Signal(Path)  # result_dir
    failed = QtCore.Signal(str, str)  # path, error
    cancelled = QtCore.Signal()
    log = QtCore.Signal(str)
    
    def start(self, config: SpectralJobConfig) -> None:
        # 后台线程执行批处理
        ...
```

**第三步：连接 GUI**
```python
# python/qtomography/gui/main_window.py
def _on_spectral_start_requested(self, payload: dict) -> None:
    config = SpectralJobConfig.from_dict(payload)
    self._spectral_runner.start(config)
```

**第四步：实现报告输出**
```python
# python/qtomography/infrastructure/persistence/spectral_reporter.py
def write_text_report(result: SpectralResult, output_path: Path) -> None:
    """生成 MATLAB 风格文本报告"""
    ...

def write_json_result(result: SpectralResult, output_path: Path) -> None:
    """生成 JSON 结果"""
    ...
```

---

## ✅ 结论

### 计划合理性：**优秀** ⭐⭐⭐⭐⭐
- 阶段划分清晰，时间估算合理
- 技术选型正确，实施指南详细
- 建议：优先实现核心功能，再逐步扩展

### 当前进展：**约 60%** 📊
- ✅ 核心算法和可视化已完成
- ⚠️ GUI 面板 UI 完成，但后端未连接
- ❌ 批处理服务和报告输出未实现

### 下一步行动：
1. 实现 `SpectralRunner` 服务（参考 `ControllerRunner`）
2. 实现 `load_density_matrix()` 函数
3. 连接 GUI 与后端
4. 实现基础报告输出

预计剩余工作量：**2-3 天**

