# é‡å­æ€å±‚æé‡æ„é¡¹ç›®æµç¨‹æ€»ç»“

> **å¿«é€Ÿç†è§£é¡¹ç›®è¿è¡Œæµç¨‹å’Œæ•°æ®æµ**

---

## ğŸ¯ **ä¸€å¥è¯æ€»ç»“**

**ç”¨æˆ·è¾“å…¥CSVæ¦‚ç‡æ•°æ® â†’ CLIè§£æå‚æ•° â†’ åº”ç”¨å±‚æ‰¹å¤„ç† â†’ é¢†åŸŸå±‚é‡æ„è®¡ç®— â†’ åŸºç¡€è®¾æ–½å±‚ä¿å­˜ç»“æœ**

---

## ğŸ“Š **æ ¸å¿ƒæµç¨‹å›¾**

```
ç”¨æˆ·å‘½ä»¤ â†’ CLIå±‚ â†’ åº”ç”¨å±‚ â†’ é¢†åŸŸå±‚ â†’ åŸºç¡€è®¾æ–½å±‚ â†’ ç»“æœæ–‡ä»¶
   â†“         â†“       â†“       â†“         â†“
 å‚æ•°è§£æ   æ‰¹å¤„ç†æ§åˆ¶  ç®—æ³•è®¡ç®—   ç»“æœæŒä¹…åŒ–    JSON+CSV
```

---

## ğŸ”„ **è¯¦ç»†æ‰§è¡Œæ­¥éª¤**

### **ç¬¬1æ­¥ï¼šç”¨æˆ·è¾“å…¥**
```bash
qtomography reconstruct data.csv --method both --dimension 4
```

### **ç¬¬2æ­¥ï¼šCLIè§£æ**
```python
# qtomography/cli/main.py
def _cmd_reconstruct(args):
    config = ReconstructionConfig(...)  # æ„å»ºé…ç½®
    result = run_batch(config)          # è°ƒç”¨åº”ç”¨å±‚
```

### **ç¬¬3æ­¥ï¼šåº”ç”¨å±‚æ§åˆ¶**
```python
# qtomography/app/controller.py
def run_batch(config):
    data = _load_probabilities(...)     # åŠ è½½CSVæ•°æ®
    linear = LinearReconstructor(...)   # åˆ›å»ºçº¿æ€§é‡æ„å™¨
    mle = MLEReconstructor(...)         # åˆ›å»ºMLEé‡æ„å™¨
    
    for idx in range(sample_count):     # æ‰¹å¤„ç†å¾ªç¯
        probs = data[:, idx]            # æå–æ¦‚ç‡å‘é‡
        
        # çº¿æ€§é‡æ„
        linear_result = linear.reconstruct_with_details(probs)
        
        # MLEé‡æ„  
        mle_result = mle.reconstruct_with_details(probs)
        
        # ä¿å­˜ç»“æœ
        save_record(linear_result)
        save_record(mle_result)
```

### **ç¬¬4æ­¥ï¼šé¢†åŸŸå±‚è®¡ç®—**
```python
# qtomography/domain/reconstruction/linear.py
def reconstruct_with_details(self, probabilities):
    probs = self._normalize_probabilities(probabilities)
    measurement_matrix = self.projector_set.measurement_matrix
    
    # æœ€å°äºŒä¹˜æ±‚è§£ - è¿™é‡Œæ˜¯çœŸæ­£çš„è®¡ç®—ï¼
    rho_vec = np.linalg.lstsq(measurement_matrix, probs)[0]
    
    rho = self._vec_to_density_matrix(rho_vec)
    rho_physical = rho.sanitize_within_tol()
    
    return LinearReconstructionResult(...)
```

### **ç¬¬5æ­¥ï¼šç»“æœä¿å­˜**
```python
# qtomography/infrastructure/persistence/result_repository.py
def save(self, record):
    # ä¿å­˜JSONæ–‡ä»¶
    with path.open("w") as fh:
        json.dump(record.to_serializable(), fh)
    
    # æ›´æ–°CSVæ±‡æ€»
    self._append_to_csv(record)
```

---

## ğŸ“ **æ•°æ®æµè½¬è¿‡ç¨‹**

### **è¾“å…¥æ•°æ®**
```csv
# data.csv
0.5,0.5,0.25,0.25
0.6,0.4,0.3,0.2
0.7,0.3,0.35,0.15
```

### **ä¸­é—´æ•°æ®**
```python
# æ¦‚ç‡å‘é‡
probs = [0.5, 0.5, 0.25, 0.25]

# å¯†åº¦çŸ©é˜µ
density_matrix = [[0.5, 0.5], [0.5, 0.5]]

# ç‰©ç†é‡
metrics = {
    "purity": 0.75,
    "trace": 1.0,
    "rank": 4.0
}
```

### **è¾“å‡ºæ•°æ®**
```json
// record_2_xxx.json
{
  "method": "linear",
  "density_matrix": [[0.5, 0.5], [0.5, 0.5]],
  "metrics": {
    "purity": 0.75,
    "trace": 1.0
  }
}
```

```csv
# summary.csv
sample,method,purity,trace
0,linear,0.75,1.0
0,mle,0.75,1.0
```

---

## ğŸ¯ **å…³é”®æ–‡ä»¶ä½ç½®**

### **å…¥å£æ–‡ä»¶**
- `qtomography/cli/main.py` - å‘½ä»¤è¡Œå…¥å£

### **æ§åˆ¶æ–‡ä»¶**
- `qtomography/app/controller.py` - æ‰¹å¤„ç†æ§åˆ¶

### **è®¡ç®—æ–‡ä»¶**
- `qtomography/domain/reconstruction/linear.py` - çº¿æ€§é‡æ„
- `qtomography/domain/reconstruction/mle.py` - MLEé‡æ„

### **ä¿å­˜æ–‡ä»¶**
- `qtomography/infrastructure/persistence/result_repository.py` - ç»“æœæŒä¹…åŒ–

---

## ğŸ’¡ **å…³é”®ç†è§£ç‚¹**

### **1. è®¡ç®—å¯åŠ¨ä½ç½®**
```python
# åœ¨ controller.py çš„ç¬¬700è¡Œå’Œç¬¬849è¡Œ
linear_result = linear.reconstruct_with_details(probs)  # çº¿æ€§é‡æ„å¯åŠ¨
mle_result = mle.reconstruct_with_details(probs)        # MLEé‡æ„å¯åŠ¨
```

### **2. æ•°æ®è½¬æ¢è¿‡ç¨‹**
```
CSVæ–‡ä»¶ â†’ æ¦‚ç‡å‘é‡ â†’ å¯†åº¦çŸ©é˜µ â†’ ç‰©ç†é‡ â†’ JSONæ–‡ä»¶
```

### **3. åˆ†å±‚èŒè´£**
- **CLIå±‚**ï¼šå‚æ•°è§£æï¼Œç”¨æˆ·äº¤äº’
- **åº”ç”¨å±‚**ï¼šæ‰¹å¤„ç†æ§åˆ¶ï¼Œæ•°æ®ç®¡ç†
- **é¢†åŸŸå±‚**ï¼šç®—æ³•è®¡ç®—ï¼Œæ ¸å¿ƒé€»è¾‘
- **åŸºç¡€è®¾æ–½å±‚**ï¼šç»“æœä¿å­˜ï¼Œæ–‡ä»¶ç®¡ç†

### **4. ä¸ºä»€ä¹ˆæ„Ÿè§‰"å…¨æ˜¯åˆ›å»ºç±»"**
- åˆ†å±‚æ¶æ„éœ€è¦å¾ˆå¤šç±»æ¥å°è£…ä¸åŒèŒè´£
- é…ç½®ã€ç»“æœã€è®°å½•éƒ½ç”¨ç±»æ¥ç®¡ç†
- ä½†çœŸæ­£çš„è®¡ç®—å°±åœ¨`reconstruct_with_details()`æ–¹æ³•ä¸­

---

## ğŸš€ **å¿«é€Ÿè°ƒè¯•æ–¹æ³•**

### **1. è®¾ç½®æ–­ç‚¹**
```python
# åœ¨ controller.py ç¬¬700è¡Œè®¾ç½®æ–­ç‚¹
linear_result = linear.reconstruct_with_details(probs)  # æ–­ç‚¹
```

### **2. æ·»åŠ æ—¥å¿—**
```python
print(f"å¤„ç†æ ·æœ¬ {idx}, æ¦‚ç‡å‘é‡: {probs}")
print(f"çº¿æ€§é‡æ„ç»“æœ: {linear_result.density.purity}")
```

### **3. æ£€æŸ¥æ•°æ®**
```python
print(f"æ•°æ®å½¢çŠ¶: {data.shape}")
print(f"æ¦‚ç‡å‘é‡: {probs}")
print(f"å¯†åº¦çŸ©é˜µ: {result.density.matrix}")
```

---

## ğŸ‰ **æ€»ç»“**

**è®°ä½è¿™å‡ ä¸ªå…³é”®ç‚¹**ï¼š

1. **è®¡ç®—å¯åŠ¨**ï¼šåœ¨`controller.py`çš„`run_batch()`æ–¹æ³•ä¸­
2. **æ ¸å¿ƒç®—æ³•**ï¼šåœ¨`linear.py`å’Œ`mle.py`çš„`reconstruct_with_details()`æ–¹æ³•ä¸­
3. **æ•°æ®æµå‘**ï¼šCSV â†’ æ¦‚ç‡å‘é‡ â†’ å¯†åº¦çŸ©é˜µ â†’ JSONæ–‡ä»¶
4. **åˆ†å±‚æ¶æ„**ï¼šæ¯å±‚éƒ½æœ‰æ˜ç¡®èŒè´£ï¼Œæ•°æ®åœ¨å±‚é—´ä¼ é€’æ—¶å‘ç”Ÿè½¬æ¢

**æ•´ä¸ªæµç¨‹å°±æ˜¯**ï¼šç”¨æˆ·è¾“å…¥æ•°æ®ï¼Œç³»ç»ŸåŠ è½½æ•°æ®ï¼Œé‡æ„å™¨è®¡ç®—å¯†åº¦çŸ©é˜µï¼Œç»“æœä¿å­˜åˆ°æ–‡ä»¶ã€‚æ‰€æœ‰çš„ç±»åˆ›å»ºéƒ½æ˜¯ä¸ºäº†å‡†å¤‡è®¡ç®—ç¯å¢ƒå’Œå°è£…ç»“æœï¼ŒçœŸæ­£çš„è®¡ç®—å°±åœ¨é‚£ä¸¤è¡Œä»£ç ä¸­ï¼
