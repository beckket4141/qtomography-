**# WLS**

**参数调节效果**

* **WLS 正则化 (**regularization**)**
  * 上调：更强地惩罚高范数/高纯度的解，算法偏向混态，能抑制噪声带来的过拟合，但可能牺牲真实纯态的细节。
  * 下调：更接近原始 WLS，允许密度矩阵追随观测概率的细微变化，噪声较大时可能导致非物理解或振荡。
* **WLS 最大迭代次数 (**max_iterations**)**
  * 上调：优化器在困难数据集上可用更多步逼近极值，适合高维或噪声较大的情况，不过耗时和数值抖动也随之增长。
  * 下调：加快运行并防止过长的“拉扯”，但若设得太小可能在尚未收敛时停止，输出会偏离最优点。
* **WLS 最小概率裁剪 (**min_expected_clip**)**
  * 上调：当理论概率极小（纯态对某些投影应为 0）时，权重被限制，不再“无限放大”这些投影的残差；可缓解仪器噪声引入的极小概率，但也会让算法对真正的小概率偏差不够敏感。
  * 下调：更忠实地把低概率视作高权重约束，有利于恢复理想纯态，但设备噪声若在这些通道上偏大，可能引起过度修正甚至不稳定。
* **WLS ftol (**optimizer_ftol**)**
  * 上调（如 1e-3）：容忍更大的目标函数变化即视为收敛，运行更快，但停在较粗糙的点，可能留下明显残差。
  * 下调（如 1e-10）：只有当 chi² 几乎不再下降时才终止，能获得更精确的最优值，但耗时更久且在噪声数据上可能出现反复迭代或数值抖动。
* **容差 (**tolerance**，密度矩阵物理化用）**
  * 上调：更容易把很小的负特征值/概率视作 0，有利于避免微小数值误差引起的报错，但可能在高精度任务里裁掉真实的细节。
  * 下调：保留更多细节并严格 enforcing 正定性，适合高精度仿真，不过会让数值噪声更容易触发警告或失败。

整体思路：根据实验噪声水平和收敛需求，先从默认值开始；若低概率通道被噪声污染，就略微增大 **min_expected_clip**/**regularization**；若发现未收敛或结果随随机初值跳动，则增大 **max_iterations**、减小 **ftol**；若运行时间太长或噪声主导结果，则反向调整。




“10000” 是 GUI 里 **WLS 最大迭代** 数字框的上限（**qtomography/gui/panels/config_panel.py (lines 121-134)** 把 **QSpinBox** 的范围固定在 100–10000），主要是为了避免无意间填入极大值导致 WLS 长时间卡住。底层实际上没有 1 万的硬性约束，**WLSReconstructor** 只检查 **max_iterations > 0**。

需要更大的值可以用以下方式绕过 GUI 限制：

1. **CLI** ：直接在命令行指定，例如
   `<span><span>qtomography reconstruct data.csv --mle-max-iterations </span><span>50000</span><span> </span></span>`

   该参数会写进 **ReconstructionConfig.wls_max_iterations**。

1. **配置文件** ：在 JSON 中把 **wls_max_iterations** 设为所需数值，GUI 加载配置时也会带入并用于运行。
2. **修改 GUI 范围** ：如果希望在界面上就能调到更高，调整 **config_panel.py** 中 **self.wls_iterations_spin.setRange(100, 10000)** 的上限，如改成 **100000**。

所以现有限制只是 UI 友好设计，不是算法壁垒。
