# QTomography 数据格式说明

> 详细说明 CSV 和 Excel 文件的数据格式要求

**版本**: v1.0.0  
**最后更新**: 2025年11月

---

## 📋 目录

1. [概述](#概述)
2. [Excel 文件格式](#excel-文件格式)
3. [CSV 文件格式](#csv-文件格式)
4. [数据格式要求](#数据格式要求)
5. [格式示例](#格式示例)
6. [常见问题](#常见问题)

---

## 📖 概述

QTomography 支持两种主要的数据输入格式：
- **Excel 文件**：`.xlsx`、`.xls`
- **CSV 文件**：`.csv`、`.txt`

**核心概念**：
- **行（Row）**：表示一个**测量基**（measurement basis）的概率
- **列（Column）**：表示一个**样本**（sample）的所有测量概率
- **行数要求**：必须是 `d²`（d 是量子态维度）

---

## 📊 Excel 文件格式

### 基本格式

Excel 文件使用 **pandas** 的 `read_excel()` 函数读取，配置为：
- **无表头**：`header=None`（第一行就是数据，不是列名）
- **工作表**：可以指定工作表名称或索引（0-based）

### 数据布局

```
┌─────────────────────────────────────────────────────────┐
│  A列(样本1)  │  B列(样本2)  │  C列(样本3)  │  ...      │
├─────────────────────────────────────────────────────────┤
│  0.25        │  0.30        │  0.20        │  ...      │ ← 测量基 1
│  0.25        │  0.20        │  0.30        │  ...      │ ← 测量基 2
│  0.25        │  0.25        │  0.25        │  ...      │ ← 测量基 3
│  0.25        │  0.25        │  0.25        │  ...      │ ← 测量基 4
└─────────────────────────────────────────────────────────┘
     ↑              ↑              ↑
   样本1          样本2          样本3
```

### 关键规则

1. **无表头**：
   - ❌ **不要**在第一行写列名（如"样本1"、"样本2"）
   - ✅ 第一行直接是数据

2. **行数要求**：
   - 必须是 `d²` 行（d 是维度）
   - 2 维系统：4 行
   - 4 维系统：16 行
   - 8 维系统：64 行
   - 16 维系统：256 行

3. **列数**：
   - 可以是任意列数（每列是一个样本）
   - 单列：处理一个样本
   - 多列：批量处理多个样本

4. **数据值**：
   - 必须是数值（浮点数）
   - 范围建议：[0, 1]（概率值）
   - 不能有文本、公式、空单元格（除非整行/整列为空）

### 工作表选择

Excel 文件可以包含多个工作表，程序支持：

- **不指定**：自动使用第一个工作表
- **按名称**：`sheet="Sheet1"`
- **按索引**：`sheet=0`（0-based，第一个工作表是 0）

### 读取方式

程序内部使用以下代码读取：

```python
import pandas as pd

# 读取 Excel 文件
frame = pd.read_excel(path, sheet_name=sheet, header=None)

# 转换为 numpy 数组
data = frame.to_numpy(dtype=float)

# 结果形状：[行数, 列数] = [d², 样本数]
```

---

## 📄 CSV 文件格式

### 基本格式

CSV 文件使用 **pandas** 的 `read_csv()` 函数读取：
- **无表头**：`header=None`
- **分隔符**：逗号（`,`）

### 数据布局

**单列格式**（一个样本）：
```csv
0.25
0.25
0.25
0.25
```

**多列格式**（多个样本）：
```csv
0.25,0.30,0.20
0.25,0.20,0.30
0.25,0.25,0.25
0.25,0.25,0.25
```

### 关键规则

与 Excel 相同：
- ❌ 无表头
- ✅ 行数必须是 `d²`
- ✅ 每列是一个样本
- ✅ 数值范围：[0, 1]

---

## ✅ 数据格式要求

### 1. 维度匹配

**行数 = d²**（d 是量子态维度）

| 维度 | 行数要求 | 说明 |
|------|---------|------|
| 2 | 4 行 | 2² = 4 |
| 4 | 16 行 | 4² = 16 |
| 8 | 64 行 | 8² = 64 |
| 16 | 256 行 | 16² = 256 |

**自动推断**：
- 如果行数是完全平方数，程序会自动推断维度
- 例如：16 行 → 自动推断为 4 维

### 2. 数据完整性

- ✅ **不能有缺失值**（NaN）
- ✅ **不能有文本**（必须是数值）
- ✅ **不能有公式**（Excel 中必须是数值，不是公式）
- ✅ **空行/空列**：会被自动忽略（如果整行/整列为空）

### 3. 数据范围

- **推荐范围**：[0, 1]（概率值）
- **实际范围**：可以是任意浮点数（但建议在合理范围内）

### 4. 归一化

- **不要求**：程序不强制要求每列归一化（和为 1）
- **建议**：如果数据是概率，建议归一化

---

## 📝 格式示例

### 示例 1：2 维系统，单样本（Excel）

**文件内容**（4 行 1 列）：
```
A列
0.5
0.3
0.1
0.1
```

**在 Excel 中**：
```
A1: 0.5
A2: 0.3
A3: 0.1
A4: 0.1
```

**程序读取**：
- 形状：`(4, 1)` - 4 行，1 列
- 维度：自动推断为 2（因为 4 = 2²）
- 处理：重构一个 2×2 密度矩阵

### 示例 2：4 维系统，多样本（Excel）

**文件内容**（16 行 3 列）：
```
A列(样本1)  B列(样本2)  C列(样本3)
0.0625      0.0700      0.0500
0.0625      0.0600      0.0700
0.0625      0.0625      0.0625
...         ...         ...
(共 16 行)
```

**程序读取**：
- 形状：`(16, 3)` - 16 行，3 列
- 维度：自动推断为 4（因为 16 = 4²）
- 处理：批量重构 3 个 4×4 密度矩阵

### 示例 3：CSV 格式，单样本

**文件内容**（`data.csv`）：
```csv
0.25
0.25
0.25
0.25
```

**程序读取**：
- 形状：`(4, 1)` - 4 行，1 列
- 维度：2 维

### 示例 4：CSV 格式，多样本

**文件内容**（`data.csv`）：
```csv
0.25,0.30,0.20
0.25,0.20,0.30
0.25,0.25,0.25
0.25,0.25,0.25
```

**程序读取**：
- 形状：`(4, 3)` - 4 行，3 列
- 维度：2 维
- 处理：批量重构 3 个样本

---

## 🔍 数据解析流程

### 步骤 1：文件读取

**Excel**：
```python
frame = pd.read_excel(path, sheet_name=sheet, header=None)
```

**CSV**：
```python
frame = pd.read_csv(path, header=None)
```

### 步骤 2：转换为数组

```python
data = frame.to_numpy(dtype=float)
```

### 步骤 3：处理一维输入

如果数据只有一列（单个样本），会自动转换为列向量：
```python
if data.ndim == 1:
    data = data.reshape(-1, 1)
```

### 步骤 4：维度推断

程序会自动推断维度：
```python
row_count = data.shape[0]  # 行数
dimension = int(np.sqrt(row_count))  # 维度 = √行数
```

### 步骤 5：重构处理

对每一列（每个样本）执行重构：
```python
for col in range(data.shape[1]):
    probabilities = data[:, col]  # 取一列
    density = reconstructor.reconstruct(probabilities)
```

---

## ❓ 常见问题

### Q1: 第一行可以是列名吗？

**A**: ❌ **不可以**。程序使用 `header=None`，第一行会被当作数据。

**错误示例**：
```
样本1,样本2,样本3    ← 这行会被当作数据，导致错误
0.25,0.30,0.20
0.25,0.20,0.30
...
```

**正确示例**：
```
0.25,0.30,0.20    ← 第一行直接是数据
0.25,0.20,0.30
0.25,0.25,0.25
0.25,0.25,0.25
```

### Q2: 数据可以放在 Excel 的任意位置吗？

**A**: ✅ **可以**，但需要注意：
- 程序会读取整个工作表
- 空行和空列会被自动忽略
- 但建议从 A1 开始放置数据，避免混淆

### Q3: Excel 中可以使用公式吗？

**A**: ⚠️ **不推荐**。程序读取的是**计算后的数值**，不是公式本身。
- 如果公式计算结果是数值，可以工作
- 但如果公式引用其他单元格且未计算，可能出错
- **建议**：在 Excel 中先计算好，或复制为数值

### Q4: 数据必须归一化吗？

**A**: ❌ **不强制**。程序不要求每列的和必须为 1。
- 但如果数据是概率，建议归一化
- 归一化有助于提高重构精度

### Q5: 可以处理多少个样本？

**A**: ✅ **理论上无限制**。
- 单列：处理 1 个样本
- 多列：可以处理任意多个样本（每列一个）
- 实际限制取决于内存和计算时间

### Q6: 行数不是完全平方数怎么办？

**A**: ⚠️ **会出错**。
- 程序要求行数必须是 `d²`
- 如果行数不匹配，会提示错误
- 例如：15 行无法推断维度（15 不是完全平方数）

### Q7: 如何处理多个工作表？

**A**: 可以通过参数指定：
- **GUI**：在配置面板中指定工作表名称或索引
- **CLI**：使用 `--sheet` 参数
  ```bash
  qtomography reconstruct data.xlsx --sheet "Sheet2"
  qtomography reconstruct data.xlsx --sheet 1  # 第二个工作表（0-based）
  ```

### Q8: 数据中有缺失值（NaN）怎么办？

**A**: ❌ **不支持**。
- 程序要求数据完整，不能有缺失值
- 如果 Excel 中有空单元格，会被读取为 NaN，导致错误
- **解决**：填充缺失值或删除空行/空列

---

## 📐 数据格式检查清单

在准备数据文件前，请确认：

- [ ] **无表头**：第一行是数据，不是列名
- [ ] **行数正确**：行数 = d²（d 是维度）
- [ ] **数据完整**：没有空单元格、缺失值
- [ ] **数值格式**：所有单元格都是数值，不是文本或公式
- [ ] **工作表**：如果 Excel 有多个工作表，确认使用哪个
- [ ] **数据范围**：数值在合理范围内（建议 [0, 1]）

---

## 🔧 数据准备技巧

### 在 Excel 中准备数据

1. **从 A1 开始**：将数据放在 A1 单元格开始的位置
2. **删除表头**：如果有表头，删除第一行
3. **检查空值**：确保没有空单元格
4. **转换为数值**：
   - 如果数据是文本格式，选中列 → 右键 → "转换为数字"
   - 或使用 `VALUE()` 函数
5. **检查公式**：
   - 选中数据区域 → 复制 → 选择性粘贴 → "数值"
   - 这样可以确保是数值，不是公式

### 在 Python 中准备数据

```python
import pandas as pd
import numpy as np

# 创建示例数据（4 维系统，3 个样本）
dimension = 4
num_samples = 3
num_rows = dimension ** 2  # 16 行

# 生成随机概率数据
data = np.random.rand(num_rows, num_samples)
# 归一化（每列和为 1）
data = data / data.sum(axis=0)

# 保存为 Excel（无表头）
df = pd.DataFrame(data)
df.to_excel('probabilities.xlsx', index=False, header=False)

# 保存为 CSV（无表头）
df.to_csv('probabilities.csv', index=False, header=False)
```

---

## 📚 相关文档

- [用户使用指南](USER_GUIDE.md) - 如何使用 GUI 加载数据
- [CLI 使用指南](../docs/implemented/cli-usage-guide.md) - 如何使用 CLI 处理数据

---

**最后更新**: 2025年11月  
**文档版本**: 1.0.0

如有问题，请查看 [用户使用指南](USER_GUIDE.md) 或提交 Issue。

